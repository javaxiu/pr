(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{310:function(t,a,s){"use strict";s.r(a);var e=s(14),r=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"electron-经验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#electron-经验"}},[t._v("#")]),t._v(" Electron 经验")]),t._v(" "),a("p",[t._v("本文讲的是尽量站在一个 web 开发人员的角度，从 0 开始如何快速直白的了解 electron 是什么东西，并且将一些经验性的东西拿出来聊一聊。官网轻松能找到的东西就会一笔带过，代码也不会贴太多")]),t._v(" "),a("h2",{attrs:{id:"简单初识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单初识"}},[t._v("#")]),t._v(" 简单初识")]),t._v(" "),a("h3",{attrs:{id:"一句话介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一句话介绍"}},[t._v("#")]),t._v(" 一句话介绍")]),t._v(" "),a("p",[t._v("把 Chrome 和网页一起打包起来的软件，同时还给你一个可以运行 Nodejs 的环境。\n事实上，我们写的代码最终都会被打包到一个或若干 asar 文件，对于 electron 本身的定制，是少之又少的。所以 electron 开发，既是一个很舒服的环境，也是一个很不舒服的环境。\nelectron 之于前端，就像 小程序之于前端，并没有太多难点的东西，只是稍微需要多考虑一些系统 api、程序长时运行稳定性。")]),t._v(" "),a("h3",{attrs:{id:"优点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优点"}},[t._v("#")]),t._v(" 优点")]),t._v(" "),a("p",[t._v("它可以让前端开发用 web 技术栈去实现一个桌面 app，一个 web 开发人员几乎不需要有太多前置学习，就可以非常轻松入门使用。react？vue？angular? 原生js ? 技术栈和 single-spa 没有区别。\nelectron 的更新还是比较频繁的，社区活跃度还可以。基本上会跟随 nodejs / Chrome 发布新版本。实际上你去看 release note 也基本上都讲更新到了最新 node/chrome 版本")]),t._v(" "),a("h3",{attrs:{id:"缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),a("p",[t._v("在于如果出现了崩溃、蓝屏等底层错误，就只能求助于 "),a("a",{attrs:{href:"https://github.com/electron/electron/issues",target:"_blank",rel:"noopener noreferrer"}},[t._v("electron 官方社区"),a("OutboundLink")],1),t._v("，issue 区常年千把个 open 状态的 issue，你的问题容易复现还有可能会有人帮看一下，如果是不容易复现的，直接挂一段时间给 close 也是有的，比较被动。")]),t._v(" "),a("p",[t._v("另外，请注意：Windows 版本如果期望支持到 "),a("strong",[t._v("win7 32位，electron 版本只支持到 5.x")]),t._v("，从 6.x 开始启动直接黑屏，渲染进程疯狂 crash。实验方式很简单，直接下载 release 包放到机器上运行。")]),t._v(" "),a("h2",{attrs:{id:"哪些产品是用electron"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#哪些产品是用electron"}},[t._v("#")]),t._v(" 哪些产品是用electron")]),t._v(" "),a("p",[t._v("阿里郎、大名鼎鼎的 vscode、有道笔记、字节跳动的飞书（新版本好像不是了）、迅雷Windows版，还有网易杭研一些政府应用的 web 站点开始是 web 部署，但是考虑安全性和易用性，把 web 应用离线下来打成 electron 应用（别问我怎么知道的，问就是我有个朋友）。\n下面这个是拿飞书举个栗子，看看里面的结构：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529283064-ce12a2c0-6c59-4dd0-b420-7dc1bceaed92.png",alt:"1586685156965-e585e0ad-6613-4557-895a-7676dcb019a3.png"}})]),t._v(" "),a("p",[t._v("这个结构就是标准 electron 应用的结构啦，在 xxx.app/Contents/Resource 下面放了一个 app.asar，基本上就是 electron 应用的标志。当然，asar 只是充分非必要条件，有些是直接放的未打包成  asar 的文件夹")]),t._v(" "),a("h2",{attrs:{id:"几个基本环节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#几个基本环节"}},[t._v("#")]),t._v(" 几个基本环节")]),t._v(" "),a("p",[t._v("简单到只有一个 hello word html 文件，和写完之后可以双击就可以在浏览器打开一样，你也可以用 electron 直接打开这个 html 文件。稍微不同的是 electron 需要先运行一段 nodejs 代码：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BrowserWindow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadURL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://taobao.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"node-职责"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-职责"}},[t._v("#")]),t._v(" node 职责")]),t._v(" "),a("p",[t._v("不是说 electron 其实就是个 Chrome 离线版 web 应用吗？为啥还要node？什么场景下需要用到 nodejs 而不是浏览器？下面举几个建议放在 node 端做的例子")]),t._v(" "),a("h4",{attrs:{id:"创建窗口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建窗口"}},[t._v("#")]),t._v(" 创建窗口")]),t._v(" "),a("p",[t._v("因为 electron 运行我们代码的第一步是我们写的 nodejs，在创建了窗口之后才开始执行我们的 html/js （要有皮才能长毛，没有窗口哪有浏览器环境）。窗口可以创建多个，窗口的管理应该尽可能放在 node 端。如果你在第一个窗口的浏览器代码里创建了另一个窗口，那么这俩窗口是强绑定关系，一旦第一个窗口因为某种原因销毁了，你也就失去了对第二个窗口的控制。（虽然可以通过一些 BrwoserWindow api 来重新获得控制，但不建议这么做，状态管理不中心化会带来开发和运行上的很多不确定性）。\n由于每个窗口实际上都相当于我们传统的开发一个 web 页面，所以每个窗口都要有对应的一组 html/js。\n例如如果你做的是一个"),a("strong",[t._v("窗口级别对话框")]),t._v("，那么当你点击对话框中的确定按钮，")]),t._v(" "),a("h4",{attrs:{id:"托盘图标及托盘菜单-tray"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#托盘图标及托盘菜单-tray"}},[t._v("#")]),t._v(" 托盘图标及托盘菜单（Tray）")]),t._v(" "),a("p",[t._v("也就是这个啦，Windows 和 Mac 都是它")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529293723-732ea083-07ff-4d8c-8048-6ede01bed2fc.png",alt:"1586682932152-1f8ad656-1f18-4627-800d-6177cbb5320a.png"}}),t._v(" 。")]),t._v(" "),a("p",[t._v("需要一提的是，Mac  的托盘图标尽量只用黑色和透明通道，Mac 10.15 黑暗模式下，Mac 会自动将颜色翻转。如果黑的不够彻底，那么黑暗模式下也就白的不够彻底")]),t._v(" "),a("p",[a("img",{attrs:{src:"/skylark/lark/0/2020/png/107024/1586683711578-6dff7176-92ef-40d5-aef9-05ca69797b1e.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"mac应用菜单-menu"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mac应用菜单-menu"}},[t._v("#")]),t._v(" Mac应用菜单（Menu）")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529309395-13c9ae9f-f91f-42d1-ab38-a6565a5c931d.png",alt:"1586682932152-1f8ad656-1f18-4627-800d-6177cbb5320a.png"}})]),t._v(" "),a("p",[t._v("这个菜单通常需要自己配置")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" template "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" appConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("appname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Alimeeting"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"submenu"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Quit"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Command+Q"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'quit'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"quit"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Edit"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"submenu"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"undo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CmdOrCtrl+Z"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"undo"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"redo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Shift+CmdOrCtrl+Z"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"redo"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"separator"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cut"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CmdOrCtrl+X"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cut"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"copy"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CmdOrCtrl+C"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"copy"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"paste"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CmdOrCtrl+V"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"paste"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"label"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"selectall"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"accelerator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CmdOrCtrl+A"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"selectall"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      label"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Window'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      role"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'window'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      submenu"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" label"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'minimize'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" accelerator"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CmdOrCtrl+M'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" role"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'minimize'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" label"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hide'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" accelerator"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CmdOrCtrl+H'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" role"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hide'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" MenuItemConstructorOptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("attachEvent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  Menu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setApplicationMenu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Menu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildFromTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("注意，上面的字段中， accelerator 是指快捷键，role 标识功能。有几个默认的 role 值，例如 cut/copy/paste/ 是复制粘贴，不需要自己写 onclick 行为，role 即有默认行为。在  electron 5.x 版本以前，如果你没有手动配置这几个 role，你甚至无法做到在控制台(inspector) 里面做复制粘贴操作。到 electron 6.x 开始才默认内置了下面这套。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529327623-a3da99ae-1688-4374-990f-ccf1db6b9eb8.png",alt:"1586686635850-2a5b1987-f3b9-4750-b1a4-7a1e394349e8.png"}})]),t._v(" "),a("p",[t._v("但这套在正式发布的应用里肯定不能就这么赤裸裸把调试功能开给所有用户。所以通常需要自己覆盖。只要自己设定了 setApplicationMenu 之后，app 菜单栏就会只显示你配置的条目。")]),t._v(" "),a("h4",{attrs:{id:"protocol-handler"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#protocol-handler"}},[t._v("#")]),t._v(" Protocol handler")]),t._v(" "),a("p",[t._v("就是通过浏览器打开一个指定的 url 例如浏览器中访问： alilang://meeting?type=newlive&liveId=12345&uuid=8caa36d0-3d2c-4ce5-9e80-xxxxxx   会直接打开阿里郎并进入一场会议，和当年入门学习 html 的时候提到的 mailto:xxxx  没有什么本质区别")]),t._v(" "),a("h4",{attrs:{id:"文件读写-系统io"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件读写-系统io"}},[t._v("#")]),t._v(" 文件读写 / 系统IO")]),t._v(" "),a("p",[t._v("类似于要读取文件、tcp/udp、蓝牙等系统IO，建议优先考虑放在 node 端开发。")]),t._v(" "),a("h4",{attrs:{id:"为什么这些要放在-node-环境下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么这些要放在-node-环境下"}},[t._v("#")]),t._v(" 为什么这些要放在 node 环境下")]),t._v(" "),a("p",[t._v("浏览器实际上也可以直接使用 nodejs 的 api，只要开启 nodeIntegration , 在浏览器环境直接用包括 fs 文件系统在内的各种 nodejs 的 api 都是允许的。但是这种操作并不建议做，理由如下：")]),t._v(" "),a("ul",[a("li",[t._v("非 UI 耗性能操作放 node 会让你的系统更稳定。这点不论述，请参考为什么小程序要搞双线程渲染。")]),t._v(" "),a("li",[t._v("nodeIntegration 不建议开启，以完全阻断在前端使用 node api 的可能。否则当你的业务团队扩大，开发人员增加，node api 可能会在前端滥用，前端会做了很多原本没必要在前端做的事情。同时也让逻辑混杂，让前端逻辑不再纯粹。职责单一性划分更清晰。")])]),t._v(" "),a("h3",{attrs:{id:"前端环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端环境"}},[t._v("#")]),t._v(" 前端环境")]),t._v(" "),a("h4",{attrs:{id:"和-single-spa-的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#和-single-spa-的区别"}},[t._v("#")]),t._v(" 和 single spa 的区别")]),t._v(" "),a("blockquote",[a("p",[t._v("术语介绍： "),a("a",{attrs:{href:"https://www.npmjs.com/package/asar",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[t._v("asar")]),a("OutboundLink")],1),t._v(" 可以简单理解为类似 iso 镜像，可以被挂载直接读取里面的文件而不需要解压，里面可以包含文件夹。")])]),t._v(" "),a("p",[t._v("和 single spa 前端技术栈几乎是没有差异的。从上面那段 hello world 可以看出来，一个 BrowserWindow 等同于一个 Chrome 窗口，可以加载 http 地址，也可以加载本地文件。")]),t._v(" "),a("h4",{attrs:{id:"调试环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调试环境"}},[t._v("#")]),t._v(" 调试环境")]),t._v(" "),a("h5",{attrs:{id:"devtools"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#devtools"}},[t._v("#")]),t._v(" devtools")]),t._v(" "),a("p",[t._v("唤起控制台是每个前端开发必须要有的基本开发调试环境。上面有提到，menu 中可以开启和关闭 inspector。那么如果关闭了，岂不是没法调出来菜单项了？")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[t._v("win "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BrowserWinodw")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("isDev"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\twin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("webContents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("openDevTools")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'detach'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在创建 Window 之后可以调用这种方式将控制台唤起。其中 mode = detach 意思是分离模式，几种请看下图")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529345414-21c86dca-975d-4fe1-a46c-e6fd274dc60a.png",alt:"1586687485913-ab2209f9-bb15-4e51-acb6-066061ea6a33.png"}})]),t._v(" "),a("h5",{attrs:{id:"react-devtools"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react-devtools"}},[t._v("#")]),t._v(" React Devtools")]),t._v(" "),a("p",[t._v("React 开发少不了 Devtools，electron 默认是不会加载我们 Chrome 已经安装的 devtools 的。可以按照如下操作安装。该安装是一次性行为，安装之后基本不会需要再次安装。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529360820-0b98fb2a-0b1e-4f7b-ba3a-bcfda35ebdaa.png",alt:"1586687628515-ee185c87-34bd-4756-82dd-f4d3ded31b72.png"}})]),t._v(" "),a("h4",{attrs:{id:"打包部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打包部署"}},[t._v("#")]),t._v(" 打包部署")]),t._v(" "),a("p",[t._v("因为是本地应用，一般而言其实更建议是加载本地文件，否则要去加载在线地址，那白屏加载体验相信是不会太好的。\nsingle spa 开发完成之后，一般是会生成 app.min.js + app.min.css + index.html, 这些文件通常是通过 cdn 发布。而要打包成本地文件，就是将这几个文件放到 electron 这个壳里，例如下面的结构")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("/Contents/Resources/app.asar/\n├── app.min.js\n├── index.html\n├── main.js\n├── package.json\n├── react.production.min.js\n└── tray\n    ├── logo.png\n    ├── trayicon-macTemplate.png\n    ├── trayicon-macTemplate@1.5x.png\n    ├── trayicon-macTemplate@2x.png\n    ├── trayicon-macTemplate@3x.png\n    ├── trayicon-macTemplate@4x.png\n")])])]),a("p",[t._v("electron 会找目录下的 /Contents/Resources/app.asar/，从里面读取 package.json 文件。package.json 文件会有 main 字段，该字段表达的就是 electron 应该执行的入口，也就是我们上面那段 app.on('ready'....  那段入口。而我们的前端代码都有这个 node 开始加载运行")]),t._v(" "),a("p",[t._v("这里 app.asar 并非必要的，也可以直接发布 app 文件夹，里面内容平铺。但这不太好的是文件并非一个整体文件，在传输、安装过程，文件量大容易出错，而且不易于拷贝。所以业界习惯一般是给一个 asar 文件。")]),t._v(" "),a("h4",{attrs:{id:"webpack-特殊配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#webpack-特殊配置"}},[t._v("#")]),t._v(" webpack 特殊配置")]),t._v(" "),a("p",[t._v("由于我们不可避免可能需要用到一些 electron 的 api ，而我们前端开发现在都依赖于 webpack 的构建。就会出现依赖问题。例如 "),a("code",[t._v("require('electron').ipcRenderer")]),t._v(" 这种写法，webpack 可能会去找 electron 包，实际上这行代码是 electron 浏览器运行环境下就支持，require 函数都是 electron browser 环境自带的，没必要也不应该处理。所以 webpack 提供了两个特殊的 "),a("a",{attrs:{href:"https://webpack.docschina.org/configuration/target/#src/components/Sidebar/Sidebar.jsx",target:"_blank",rel:"noopener noreferrer"}},[t._v("target"),a("OutboundLink")],1),t._v(" "),a("code",[t._v("electron-renderer | electron-main")]),t._v("。即 Browser 环境 / node 环境，告诉 webpack 要忽略 require('electron') ，并把  import xxx from 'electron' 转换成这种代码。")]),t._v(" "),a("h4",{attrs:{id:"页面请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#页面请求"}},[t._v("#")]),t._v(" 页面请求")]),t._v(" "),a("p",[t._v("由于我们的页面是本地部署，那么文件的 window.location 必然是类似于  file:///Application/xxx.app/Contents/Resources/app.asar/index.html 这样的，那么通过 http 去请求任何服务器都是跨域，那岂不是服务端要对所有 file:/// 的 protocol 都开跨域允许？而且真的可行吗？\n回想一下，跨域是谁限制的？其实不是服务端，是本地浏览器不让你跨域。那 electron 环境下，浏览器都是我们自己管理的，直接 disable 不就好了。实际上，创建  BrowserWindow 对象就有这么个参数：")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BrowserWindow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    webPreferences"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      webSecurity"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("p",[t._v("其实有点费解，electron 为何不做成只要 load 地址是 file:/// 的，默认开不就行了")]),t._v(" "),a("h4",{attrs:{id:"browserwindow"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#browserwindow"}},[t._v("#")]),t._v(" BrowserWindow")]),t._v(" "),a("p",[t._v("在 electron 的世界，所有的窗口都是一个 chrome window, 有多少个 window 由你在 nodejs 环境中创建多少个 BrowserWindow 决定。你可以定制窗口大小，但是你的元素必须都在一个窗口中，能做 html 能做的事（动画特效、div 变化），但是下面这种骚操作是打死也做不了的")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529384582-4cb0d235-7b03-4e5a-a08d-eb53af877f91.png",alt:"1586682091676-1a1ac6a7-09bc-495c-a049-548a1615ed1a.png"}})]),t._v(" "),a("p",[t._v("好吧，其实非要做也可以，当检查到有超出范围的就扩大窗口 (BrowserWindow.setBounds)，让窗口背景是透明的，看起来似乎就是超出窗口了。不过这种写法相信没几个有正义感的开发会同意这么做 ; )")]),t._v(" "),a("p",[t._v("所以你要做类似钉钉 ding 一下从桌面右上角强势插入的通知消息，实际上也是创建个 BrowserWindow。BrowserWindow 本身也支持位置变化动画（win.setPosition(x, y[, animate]))。")]),t._v(" "),a("h3",{attrs:{id:"版本-release"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#版本-release"}},[t._v("#")]),t._v(" 版本 release")]),t._v(" "),a("p",[t._v("相对于 web 开发而言，web 一般操作是发布完成 cdn 文件之后，交由 vm 部署就完成了。而 electron 是有软件版本 release 的过程的。这个过程可以简单描述如下：")]),t._v(" "),a("h4",{attrs:{id:"mac"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mac"}},[t._v("#")]),t._v(" Mac")]),t._v(" "),a("p",[t._v("前端构建 -> app.asar -> electron-build -> dmg/pkg build -> app sign -> nortarize")]),t._v(" "),a("p",[t._v("step1:  前端 webpack 构建完成之后得到的 js 文件，一般来说需要打包为 app.asar。当然也可以不打包 asar\nstep2:  下载官方 release 的 electron.app 包，然后把 asar 文件丢进这个包的 Contents/Resources/ 下\nstep3:  修改图标、plist文件（应用名、bundleid）等\nstep4:  给 electron.app 签名。做过安卓/ios开发的同学应该都了解，软件签名不可少，用来标识 app 开发商。这个过程是对包内所有文件逐个签名的。所以你的文件越多，签名越慢。这也是为什么一般要打 app.asar 的原因之一\nstep5:  给 app 公证。Mac 10.15 后开始强制要求的。其过程大概是将 app 上传到苹果应用商店，解压出来你的安装包，逐个文件进行验证。如果你的包内有 xxx.rar 或者 xxx.zip 文件，甚至 xxx.abc，只要是 zip 文件，苹果也都会解压出来进行分析（苹果递归看里面的内容这种骚操作是从2020年1月份开始的，我深受其坑）\nstep6:  公证完成之后，你的 app 就可以分发给别人安装了，如果未公证可能会出现如下问题")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529413698-106d18a2-7822-4b39-9d8b-dcb2d24206c5.png",alt:"1586689087688-ae129454-c622-4f79-91cb-109e15109f72.png"}})]),t._v(" "),a("p",[t._v("然而公证真的是特别费时的行为，因为涉及到包文件上传到Mac 服务器，多少受到网络环境制约，而且还是海外的，偶尔还会被墙。所以我们一般在开发阶段是不开启公证流程。那么别人拿到的包还是上图这个样子别人也用不了怎么办？")]),t._v(" "),a("ul",[a("li",[t._v("解法一：用户安装后右键 -> 打开  即可。双击无法打开，但是通过菜单可以。苹果这个设计真妙啊……")]),t._v(" "),a("li",[t._v("解法二：xattr -rd com.apple.quarantine /Applications/xxxx.app  意思是删除隔离声明。Mac 系统从网上下载的文件都会被带上 quarantine 标识，即便你原始文件并没有这个属性，只要你通过钉钉、http 下载等方式传输到你电脑上，都会自动带上。而通过这行命令实际上就是删除掉这个隔离标识的。这样 Mac 就会认为这个文件是你电脑本来就有的，不需要隔离。（联想到 COVID-19，这手动瞒报并解除 quarantine 的骚操作是不是有点……）")])]),t._v(" "),a("p",[t._v("以上这些步骤，在 step2+step3+step4 , electron-packager 这个工具里都有体现。但是有个问题是 electron-packager 在做 step2 的下载官方 release 包的时候，会直接从海外镜像上拉取，这步会异常慢。我尝试过各种缓存路径修改、fork 源码、预先下载文件到缓存目录，但是效果都不太好。后来想到这个办法：")]),t._v(" "),a("ul",[a("li",[t._v("在配置 的 Option 中，覆盖 download")])]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[t._v("download"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      unsafelyDisableChecksums"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      downloader"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t  \t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("downoload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Promise")]),t._v("\n\t  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("关键是 diable 掉 md5 sums 检查，另外，download 里面，下载途径可以使用 taobao 镜像，这样就能完美解决版本号随时可升级、国内加速、md5检查 等问题。")]),t._v(" "),a("p",[t._v("以上这些步骤，都可以写成 node 脚本，放在"),a("a",{attrs:{href:"http://mtl3.alibaba-inc.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("摩天轮"),a("OutboundLink")],1),t._v("下自动执行打包。包括下载加速、签名优化、公证优化等步骤优化之后，原有的阿里郎需要 45 分钟甚至 1 个小时（摩天轮是1个小时超时，如果超过 1个小时自动关闭任务，打包失败），我优化到的效果是打包 5 分钟，公证 8 分钟，提速超过 300%")]),t._v(" "),a("h4",{attrs:{id:"mac-的-icns-图标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mac-的-icns-图标"}},[t._v("#")]),t._v(" Mac 的 icns 图标")]),t._v(" "),a("p",[t._v("Mac 打包需要提供一个 icns 图标，icns 也就是 icons 的缩写。为什么是复数? 因为它要在不通环境下展示，Applications 文件夹下就有多个不通图标显示方式，为避免缩小带来的狗牙效果，需要提供几组可控的观感图片。\n不过我们平时开发的程序，logo 都是固定的，要按照官方的做法提供好几套尺寸真的很麻烦。比如 sips -z 16 16 这种命令要执行 8 次，然后还要执行一个 iconutil -c icns tmp.iconset -o Icon.icns 来把刚才生成的一堆图片合成一个。")]),t._v(" "),a("p",[t._v("这里推荐一个 npm 工具，"),a("a",{attrs:{href:"https://web.npm.alibaba-inc.com/package/png2icons",target:"_blank",rel:"noopener noreferrer"}},[t._v("png2icons"),a("OutboundLink")],1),t._v(" 一次性搞定。")]),t._v(" "),a("p",[t._v("然而，我打出来的 icns 图标好大，比别的图标要大一大圈，比如下面这种")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529429667-63b7acd7-0643-49d1-8a1c-79039a05b8f9.png",alt:"1586697829891-473ff7f4-9807-4d00-8277-7efe332dff71.png"}})]),t._v(" "),a("p",[t._v("咋办呢？难道是我姿势不对？参考了一圈，发现别人的做法简单粗暴：就是在 png 原图上搞一个出血位，空出来一圈。经过我“严密测算”，图片内容缩小到 87.5%  是最佳大小。也就是流出来 22.5% 的出血位")]),t._v(" "),a("h4",{attrs:{id:"windows"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#windows"}},[t._v("#")]),t._v(" Windows")]),t._v(" "),a("p",[t._v("Mac 部分完全可以在摩天轮上一键完成，那么 Windows 要怎么做呢？在步骤上，和 Mac 是差不多的：\n前端构建 -> app.asar -> electron-build -> exe builder -> 签名（开发商签名+签版本号）")]),t._v(" "),a("p",[t._v("第一步：同Mac\n第二步：同 Mac，都由 electron-packager 构建完成，产物是一个 xxx-x86.zip\n第三步:  将上一步的 zip 文件交给 windows 开发同学，打包 exe 安装程序，并签名")]),t._v(" "),a("p",[t._v("以上第二个步骤，和 Mac 其实有个不同点，Mac 在这里就签了 app 版本号等，升级维护都依赖这个版本号，而 windows 有自己的版本号管理方式。而且构建 zip 包其实跟 Mac 并不完全是一个目的，mac 是有这个才能继续打包 dmg，而 Windows 只要构建过一次，图标.ico 文件签到了 electron.exe 启动文件上，后续其实就不需要再次打包了。所以以上步骤可以修改为")]),t._v(" "),a("p",[t._v("第零步：电脑本地通过 electron-packager 构建一个指定了 electron 版本+图标的安装目录并打成 zip 包，提供给 Windows 开发同学。这步只需要做一次，以后不需要再给\n第一步：从 Mac 构建产物中把全部 asar 文件提取出来，提供给 windows 开发同学\n第二步：Windows 开发同学将 asar 文件替换，重新构建 exe 并签名等。")]),t._v(" "),a("p",[t._v("以上步骤可以在 jenkins 中完成。需要一台 windows 电脑。摩天轮是 Mac 实体机，并不太合适做 Windows 构建。")]),t._v(" "),a("p",[t._v("只需要牢记一个点：**前端的所有开发产物，都在 "),a("em",[t._v(".asar 文件中")]),t._v("。 dmg / exe 是套上了 electron 壳提供给用户实际使用的可执行程序")]),t._v(" "),a("p",[t._v("只要记住这点，你甚至可以本地构建 xx.asar 文件，让用户替换文件后重启，程序就是你的新版本程序了。实际上阿里郎快速解决部分用户问题就是通过这种临时提供补丁包的方案。")]),t._v(" "),a("h2",{attrs:{id:"如何跟-c-协同"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何跟-c-协同"}},[t._v("#")]),t._v(" 如何跟 C++ 协同")]),t._v(" "),a("p",[t._v("有一些底层程序开发，不管是从高性能、系统 api 接入、安全性等角度，例如阿里郎的 WiFi 管理、VPN接入等，这些并不是 nodejs 所擅长的，所以需要有 c++ / objective c 的 native 程序来协同")]),t._v(" "),a("h3",{attrs:{id:"方案一-node-扩展"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案一-node-扩展"}},[t._v("#")]),t._v(" 方案一:  node 扩展")]),t._v(" "),a("p",[t._v("嗯……我买了死月大佬的 《来一打nodejs c++ 扩展》（此处需要广告费）\n有些 node 包（例如 icework 用到的 c++ 编译 sass），里面会有 .node 后缀的文件。事实上，nodejs 核心库里很多 api 都是通过 .node 扩展支撑的。完全可以通过这种方式提供底层 api 支撑，也就是 "),a("a",{attrs:{href:"https://nodejs.org/api/addons.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("nodejs addon"),a("OutboundLink")],1),t._v("\n当然，node 本身支持的 "),a("a",{attrs:{href:"https://nodejs.org/api/n-api.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("N-api"),a("OutboundLink")],1),t._v(" 也是个好东西，是一种新的 addon 方案\n另外，还有 "),a("a",{attrs:{href:"https://web.npm.alibaba-inc.com/package/ffi",target:"_blank",rel:"noopener noreferrer"}},[t._v("ffi"),a("OutboundLink")],1),t._v("，大概原理是内存共享，有可能会因为内存操作问题出现 crash ，但是谨慎处理的话也没什么问题。我稍微尝试过这种方案，感觉写起来挺 sexy 的\n这些方案都挺优秀，我都有尝试过。个人稍微倾向 .node 扩展。毕竟 node 核心库都是用这种方案的。")]),t._v(" "),a("p",[t._v("相类似的你可能会想到 webassemply，不过这本质上还是运行在 chrome 环境下，可用的 api 仍然受限于Chrome 环境。因此只是具备了运行 C++ 的能力，而并不能解决系统 api 使用的问题")]),t._v(" "),a("p",[t._v("值得一提的是，"),a("strong",[t._v("早期的")]),a("a",{attrs:{href:"https://www.infoq.cn/article/oh79weak7z3s2xavo*bv",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[t._v("飞书使用的就是 ffi 的方式，后来改成了 rust")]),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"方案2-5-neon-binding"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案2-5-neon-binding"}},[t._v("#")]),t._v(" 方案2.5：neon-binding")]),t._v(" "),a("p",[t._v("飞书后来改成的 rust ，是基于 "),a("a",{attrs:{href:"https://neon-bindings.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("neon-binding"),a("OutboundLink")],1),t._v(" 实现的，部分 native 实现直接通过 rust 实现跨平台，如果是使用到一些现成 c++ 库，可以使用 rust 的天然能力对接的 c++ (rust -> c+ 的 ffi)\n为什么叫方案 2.5，因为 neon 背后也是基于 NApi 实现的")]),t._v(" "),a("p",[t._v("addon 的打包是无法打包在 asar 里的，因为 asar 的读取是不支持 .node 扩展。需要 asar unpack 的机制")]),t._v(" "),a("h3",{attrs:{id:"方案二-双进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案二-双进程"}},[t._v("#")]),t._v(" 方案二：双进程")]),t._v(" "),a("p",[t._v("说白了就是前端一个 electron 进程，native 一个进程。两个进程之间通过 ipc 通信。阿里郎目前的协作方案就是这种，除了一些历史包袱原因导致这个现状之外，还因为双进程可以互相独立，能做到一些类似前端进程退出了，但 vpn 还能用之类的效果（虽然目前产品设定不能这么做，但至少提供了技术可能性）。")]),t._v(" "),a("p",[t._v("ipc 通信方案用 Mac 的 socket 和 Windows  的 pipe，用起来和 tcp 没有什么差别 (下文我就简称 tcp 了，虽然有点不严谨，请忽略)。")]),t._v(" "),a("p",[t._v("具体操作大概是这样：native 开发同学开发一个可单独执行的程序，交付给前端。而前端与它的对接，类似 web 与服务端的对接。这里需要解决以下几个问题：")]),t._v(" "),a("ol",[a("li",[t._v("native 进程唤起。你需要给 native 程序保活，和 web 不同的是，当你发现无法连接成功时，web 直接 500 装死就完了。但是 electron 不能装死，要在 node 环境中使用 cmd 命令行方式把 native 进程拉起来。( Mac 是 open 命令， windows 是 start 命令）")]),t._v(" "),a("li",[t._v("进程连接。native 启动之后，双方协商谁做 server，client 端要负责连接上 server")]),t._v(" "),a("li",[t._v("通信包。和 http 不同，这里的通信是tcp，那么就需要管理三层协议。\n"),a("ul",[a("li",[t._v("第一层：tcp 包拆包拼包。因为通信 buffer 问题，如果单包超过一定大小，会出现数据包截断，类似低功耗蓝牙包限定 32 字节一样，你需要有协定每个二进制包的大小，并且知道哪些包是需要合并为一个包的。一般采用 TLC 格式，即 type+length+content。这个和前端表格分页是一样的道理，当你发现本页不是最后一页，那么你可以等候下一页过来之后组包。过程不赘叙，可以"),a("a",{attrs:{href:"https://www.jianshu.com/p/b9df1fcdcff4",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考这个"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("第二层：node -> 前端。由于上面的 tcp 是在 nodejs 端处理，要派发到上层 Windows 窗口里跑的前端代码，你还需要有这么一层转发。这个其实 electron 本身就提供了一套 ipcRenderer.send 方法")]),t._v(" "),a("li",[t._v("第三层：request / response。因为 tcp 本身并不是这个req/rep 模型，但是业务逻辑通常都是一发对一收的流程。所以有必要做这种封装。简单来说，你需要这样一个格式")])])])]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  sequenceId"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("  xxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 序列号，标识该请求和应答的对应关系. ")]),t._v("\n  topic"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" yyyyy "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 业务标识，用于告诉双端这个业务是对应到哪个业务逻辑的。类似 http 的 url")]),t._v("\n  body"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" zzzz "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// payload 参数，用于存放 request data 或者 response data")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在 request/response 模型建立之后，我们很多时候还是只能依靠日志去看发了什么，收了什么，麻烦的是消息是异步的，我们很难匹配上这些消息之间的关系。怎么办呢？可以搞一个 chrome 插件啊，把发和收组合在一起。我实现的效果如下，连名字都有点山寨 chrome 自带的 network 的味道：ipcwork")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529445223-bcd0acd5-e56f-461a-9542-5098b356cf02.png",alt:"1586699434322-cbc409aa-83a4-4c42-b57e-a7566952bfda.png"}})]),t._v(" "),a("p",[t._v("嗯……那个叉的图标没出来，可能的 chrome 插件路径计算的问题，没关系，下回更新的时候改成 inline svg 就好了。\n要开发一套 Chrome 插件，可以参考 "),a("a",{attrs:{href:"https://developer.chrome.com/extensions/devtools.panels",target:"_blank",rel:"noopener noreferrer"}},[t._v("Chrome 插件开发教程"),a("OutboundLink")],1),t._v(" 。")]),t._v(" "),a("p",[t._v("我原本以为插件都需要上架才能使用，特地去 Chrome 商店注册缴了5美元大洋，成为了一名光荣的 Google 开发者，后来发现自己脑子短路的，按照我上面那个 React Devtools 的加载方式加载进去不就行了，根本不用上架。。。。。")]),t._v(" "),a("h2",{attrs:{id:"实际业务例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实际业务例子"}},[t._v("#")]),t._v(" 实际业务例子")]),t._v(" "),a("h3",{attrs:{id:"通过-protocol-唤起"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过-protocol-唤起"}},[t._v("#")]),t._v(" 通过 protocol 唤起")]),t._v(" "),a("p",[t._v("上文有提到，Protocol 注册与唤起机制，需要在 nodejs 端进行注册。例如这样写："),a("code",[t._v("electron.app.setAsDefaultProtocolClient('ali://');")]),t._v("，那么你就把当前运行的程序注册到了系统中。")]),t._v(" "),a("p",[t._v("他们的原理大致是这样的：\nWindows 下，会在注册表中注册这么一个 command line\n"),a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529475913-cf57ad30-04a3-4725-84d9-9b457e41f942.png",alt:"1586696667782-802d7ed0-6048-49d1-bdc9-d7c525ed0fb8.png"}})]),t._v(" "),a("p",[t._v("而 mac 原理是调用一个系统 Api "),a("a",{attrs:{href:"https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html#//apple_ref/doc/uid/TP40009249-102207-TPXREF115",target:"_blank",rel:"noopener noreferrer"}},[t._v("CFBundleURLTypes"),a("OutboundLink")],1),t._v(", 将 plist 中描述的应用程序注册到。Mac 认的不是路径，是 bundle identifier")]),t._v(" "),a("p",[t._v("既然是在 nodejs 里写的这行代码 setAsDefaultProtocolClient, 那程序理所应当就是要执行到了之后才会注册。这点相信大家都能理解。但是很多人犯的这两个错误意识，有点让人匪夷所思，为了避免大家看错，我特别加上删除线\n~~1. windows 需要安装版本才能注册上 Protocol，或者注册是在安装时注册的 ~~\n"),a("s",[t._v("2. Windows / Mac  安装好就应该能通过 protocol 唤起")]),t._v("\n上面两个错误意识很明显，你都没运行你的 node 代码，怎么能注册上去？")]),t._v(" "),a("p",[t._v("当然，网上有的程序确实安装完就注册上去了，原因是人家是在 exe 安装器里执行了注册功能，或者 mac  的 pkg 里面执行了注册。但是 electron 本身是并不能做到这一点的，原因是我们的代码并不包含安装时，只有运行时。")]),t._v(" "),a("p",[t._v("这里有个坑：如果你的程序曾经运行过，已经把 protocol 注册上了，但是某次程序处于未运行状态，但是 Protocol 唤起了你的程序。那么此时你的 node 虽然可以在 on('open-url') 事件中接到相应的唤起地址，但是由于你的 window 窗口尚未创建，可能存在消息没有成功通知前端的情况。因此你需要有一套缓存机制，等到 browserwindow 真正创建并且 on(\"ready-to-show\") 的时候通过 ipcRenderer 传递给前端进程，并且在前端进程消费掉这条消息后销毁掉这个唤起记录，以免重启窗口会重复消费。")]),t._v(" "),a("h3",{attrs:{id:"怎么做一个-ding-桌面级弹窗"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#怎么做一个-ding-桌面级弹窗"}},[t._v("#")]),t._v(" 怎么做一个 Ding （桌面级弹窗）")]),t._v(" "),a("p",[t._v("钉钉在桌面右上角飘出来那个让人非常"),a("s",[t._v("恨透")]),t._v("喜欢的那个 Ding，用 electron 怎么做？\n我们上文提过，BrowserWindow 是我们的唯一且标准的可以运行我们前端代码的环境。否则就只能使用系统定制的 "),a("a",{attrs:{href:"https://www.electronjs.org/docs/api/notification",target:"_blank",rel:"noopener noreferrer"}},[t._v("notification"),a("OutboundLink")],1),t._v("。想要实现自定义样式是做不到的。\n独立的 BrowserWindow，也需要有自己的 html/js ，所以你得专门写一套，而不能把 html 文本内容、回调函数直接注册过去。比如 react 就不能把一个 react dom 传过去。事件回调还是要依靠 ipcRenderer 来传递。\n做好了一个 窗口之后，如何实现一个窗口从系统边上推出来的效果呢？窗口动画只能通过 setPosition(x, y, animate) 来触发。\n那方案可能是这样的：\nsetPosition(x, - 屏幕宽度 - 窗口尺寸, false)\nsetPosition(x, - 屏幕宽度 , true)\n很简单明了，让窗口先超出范围，然后再滑动回来。")]),t._v(" "),a("p",[t._v("然而我要泼个冷水，"),a("strong",[t._v("这个方案行不通")]),t._v("， 因为如果用户的电脑是双屏幕，带扩展屏的，那这个操作就露馅了，看起来你的通知窗口是从扩展屏移动回来主屏，会让用户一脸懵逼。")]),t._v(" "),a("p",[t._v("那怎么做呢？马上想到个很 tricky 的方案，就是 setPosition 和 setBounds 同时使用，让窗口实现右边边距固定，x 位置和宽度同时以动画效果变化，然而这个方法算起来贼啰嗦，偶尔更新不同步还出现位置抖动")]),t._v(" "),a("p",[t._v("还有一个方案：可以让窗口透明度为0，一开始就这么宽放在那儿，但是由于是透明的，用户没有感知。然后 html 内容是开始右移动100%，div 完全超出 body 范围，然后通过 css 动画给移动回来")]),t._v(" "),a("h3",{attrs:{id:"微前端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微前端"}},[t._v("#")]),t._v(" 微前端")]),t._v(" "),a("p",[t._v("在微前端大火的今天，我们 electron 作为一个客户端程序，经常需要有部分模块热更新的能力，而且业务上，我们经常提出，我们的客户端是否可以根据不同的用户，不同的租户，去动态实现不同的模块加载能力呢？我们是否也可以上一套微前端方案呢呢？\nxx.asar ，我目前看到的所有 electron-base 的程序，都是只有一个，是否就注定了 electron 也需要像 single-spa 一样都是巨石应用？\n我们做了一个实验，发现多 asar 文件的开发部署模式是完全可行的，随后在实际项目上成功使用了。")]),t._v(" "),a("p",[t._v("开发工程目录")]),t._v(" "),a("p",[a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529493651-9907beb4-3e1c-4b12-b86e-48c9edd537b8.png",alt:"1586700633842-5058b115-0dbe-4597-b5be-b05b88745f65.png"}})]),t._v(" "),a("p",[t._v("部署目录\n"),a("img",{attrs:{src:"/yuque/0/2021/png/139763/1636529516093-f09c9453-8276-4fd2-8b27-a9932299462e.png",alt:"1586700360924-4169a26e-f4d7-472e-bc91-8a1cb10cdca4.png"}})]),t._v(" "),a("p",[t._v("如图，是我们开发的多 asar 模式。其中，app.asar 作为 nodejs 入口， electron 会自动加载它，再由它加载 Login 模块、主界面框架、会议模块、网络模块等。")]),t._v(" "),a("p",[t._v("我们开发了一套自己的脚手架，能够实现这套模块化开发和部署方案。")]),t._v(" "),a("p",[t._v("事实上，我们这套脚手架不仅解决了这个模块化部署方案，甚至也提供了上文提到的 mac-builder、win-builder、摩天轮打包脚本、protocol 唤起与消息消费、ipc 通信、ipcwork-devtools、webpack 配置、双进程唤起保活等机制，把我们踩过的坑和经验都积累在里面，期望的目标是抹平 electron 开发和 web 开发的差异，让任何一个前端都能快速上手开发")]),t._v(" "),a("h2",{attrs:{id:"自动升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动升级"}},[t._v("#")]),t._v(" 自动升级")]),t._v(" "),a("h3",{attrs:{id:"全量升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全量升级"}},[t._v("#")]),t._v(" 全量升级")]),t._v(" "),a("p",[t._v("内置松鼠框架（squirrel），升级模式是全量升级，这个框架即便不用也会打包在开源版本里，除非是手动剔除。\n使用方法：\n注: 服务端接口需求 "),a("a",{attrs:{href:"https://github.com/Squirrel/Squirrel.Mac#server-support",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/Squirrel/Squirrel.Mac#server-support"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("windows 推荐使用 "),a("a",{attrs:{href:"https://jrsoftware.org/isinfo.php",target:"_blank",rel:"noopener noreferrer"}},[t._v("inno setup"),a("OutboundLink")],1),t._v(", 因为 vscode 就是用的这个方案\nmac 如果一定要用其他的可以选择 "),a("a",{attrs:{href:"https://sparkle-project.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("sparkle"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"增量升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#增量升级"}},[t._v("#")]),t._v(" 增量升级")]),t._v(" "),a("p",[t._v("由于前端开发的产物都会被打包在 *.asar 文件里，electron 如不涉及 electron 本身版本的升级，可以通过替换 asar 实现增量更新")]),t._v(" "),a("h2",{attrs:{id:"asar-保护"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#asar-保护"}},[t._v("#")]),t._v(" asar 保护")]),t._v(" "),a("p",[t._v("如上文所述，本质上 electron 开发最终产物是 js/css/html, 这些会被打包成 asar 文件，如果 js 文件中包含了敏感信息，即便 uglify 也无法有效保护。可以使用 "),a("a",{attrs:{href:"https://www.npmjs.com/package/asarmor",target:"_blank",rel:"noopener noreferrer"}},[t._v("asarmor"),a("OutboundLink")],1),t._v(" 做一层粗浅的保护")])])}),[],!1,null,null,null);a.default=r.exports}}]);