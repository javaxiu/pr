<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>编排 - 比组件更小的子元素 | xiujava</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="jiawen 的博客">
    
    <link rel="preload" href="/pr/assets/css/0.styles.3978be1e.css" as="style"><link rel="preload" href="/pr/assets/js/app.b652a85f.js" as="script"><link rel="preload" href="/pr/assets/js/2.846b7fc6.js" as="script"><link rel="preload" href="/pr/assets/js/1.bc703a74.js" as="script"><link rel="preload" href="/pr/assets/js/37.fbdf6108.js" as="script"><link rel="prefetch" href="/pr/assets/js/10.afb24a76.js"><link rel="prefetch" href="/pr/assets/js/11.26a4e38a.js"><link rel="prefetch" href="/pr/assets/js/12.972428b2.js"><link rel="prefetch" href="/pr/assets/js/13.363a2818.js"><link rel="prefetch" href="/pr/assets/js/14.da87bb03.js"><link rel="prefetch" href="/pr/assets/js/15.be6c279e.js"><link rel="prefetch" href="/pr/assets/js/16.5b27973e.js"><link rel="prefetch" href="/pr/assets/js/17.e9441626.js"><link rel="prefetch" href="/pr/assets/js/18.73cc4e61.js"><link rel="prefetch" href="/pr/assets/js/19.04ead57f.js"><link rel="prefetch" href="/pr/assets/js/20.a59fc3ba.js"><link rel="prefetch" href="/pr/assets/js/21.08fe35aa.js"><link rel="prefetch" href="/pr/assets/js/22.f5ce9d9e.js"><link rel="prefetch" href="/pr/assets/js/23.47ca722c.js"><link rel="prefetch" href="/pr/assets/js/24.4fddcd23.js"><link rel="prefetch" href="/pr/assets/js/25.633c1faa.js"><link rel="prefetch" href="/pr/assets/js/26.8ab83674.js"><link rel="prefetch" href="/pr/assets/js/27.182bd1ad.js"><link rel="prefetch" href="/pr/assets/js/28.1383b35a.js"><link rel="prefetch" href="/pr/assets/js/29.ae522b2f.js"><link rel="prefetch" href="/pr/assets/js/3.7d9825a9.js"><link rel="prefetch" href="/pr/assets/js/30.bcb96b1e.js"><link rel="prefetch" href="/pr/assets/js/31.dc8342be.js"><link rel="prefetch" href="/pr/assets/js/32.1dc6f5da.js"><link rel="prefetch" href="/pr/assets/js/33.c22b5273.js"><link rel="prefetch" href="/pr/assets/js/34.8897cec6.js"><link rel="prefetch" href="/pr/assets/js/35.5dcb8c21.js"><link rel="prefetch" href="/pr/assets/js/36.11dde236.js"><link rel="prefetch" href="/pr/assets/js/38.6c386453.js"><link rel="prefetch" href="/pr/assets/js/39.bbbe93e7.js"><link rel="prefetch" href="/pr/assets/js/4.1b5a2940.js"><link rel="prefetch" href="/pr/assets/js/40.fa8a4a55.js"><link rel="prefetch" href="/pr/assets/js/41.1337de57.js"><link rel="prefetch" href="/pr/assets/js/42.974b0c08.js"><link rel="prefetch" href="/pr/assets/js/43.5ec06833.js"><link rel="prefetch" href="/pr/assets/js/44.41d4f968.js"><link rel="prefetch" href="/pr/assets/js/45.74b1a5a1.js"><link rel="prefetch" href="/pr/assets/js/46.0b447bda.js"><link rel="prefetch" href="/pr/assets/js/47.bbf6f3b2.js"><link rel="prefetch" href="/pr/assets/js/48.4e4341c7.js"><link rel="prefetch" href="/pr/assets/js/49.b676e821.js"><link rel="prefetch" href="/pr/assets/js/5.0d0d8c0c.js"><link rel="prefetch" href="/pr/assets/js/50.89ce29be.js"><link rel="prefetch" href="/pr/assets/js/51.5d694e00.js"><link rel="prefetch" href="/pr/assets/js/52.9da5a600.js"><link rel="prefetch" href="/pr/assets/js/53.3a609c95.js"><link rel="prefetch" href="/pr/assets/js/54.c2aa27ca.js"><link rel="prefetch" href="/pr/assets/js/55.7e92886a.js"><link rel="prefetch" href="/pr/assets/js/56.b2bd260a.js"><link rel="prefetch" href="/pr/assets/js/57.bc7fc028.js"><link rel="prefetch" href="/pr/assets/js/58.0b9ba301.js"><link rel="prefetch" href="/pr/assets/js/59.30303c2b.js"><link rel="prefetch" href="/pr/assets/js/6.ec95ead8.js"><link rel="prefetch" href="/pr/assets/js/60.05f954c6.js"><link rel="prefetch" href="/pr/assets/js/7.aa392645.js"><link rel="prefetch" href="/pr/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/pr/assets/css/0.styles.3978be1e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pr/" class="home-link router-link-active"><!----> <span class="site-name">xiujava</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NLP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>低代码系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pr/pr/lc/platform.html" class="sidebar-link">生态 - 产品与平台生态</a></li><li><a href="/pr/pr/lc/framer.html" class="sidebar-link">他山 - Framer</a></li><li><a href="/pr/pr/lc/tech-choice.html" class="sidebar-link">概念 - 选型设计与调研</a></li><li><a href="/pr/pr/lc/skill-point.html" class="sidebar-link">概念 - 技术难点</a></li><li><a href="/pr/pr/lc/material.html" class="sidebar-link">入料 - 物料类型</a></li><li><a href="/pr/pr/lc/material-args.html" class="sidebar-link">编排 - 变量参数</a></li><li><a href="/pr/pr/lc/material-node.html" aria-current="page" class="active sidebar-link">编排 - 比组件更小的子元素</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pr/pr/lc/material-node.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/pr/pr/lc/material-node.html#方案" class="sidebar-link">方案</a></li><li class="sidebar-sub-header"><a href="/pr/pr/lc/material-node.html#多层与循环" class="sidebar-link">多层与循环</a></li><li class="sidebar-sub-header"><a href="/pr/pr/lc/material-node.html#方案实现" class="sidebar-link">方案实现</a></li><li class="sidebar-sub-header"><a href="/pr/pr/lc/material-node.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/pr/pr/lc/overview-parts.html" class="sidebar-link">概念 - 编辑器核心框架</a></li><li><a href="/pr/pr/lc/create-iframe.html" class="sidebar-link">细节 - 如何创建 iframe</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术分享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂谈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="编排-比组件更小的子元素"><a href="#编排-比组件更小的子元素" class="header-anchor">#</a> 编排 - 比组件更小的子元素</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>在 lowcode-engine 的画布中，可以被点击选中的区块，实际上都是一些子组件。虽然整个物料是被一起加入到画布当中的，但是实际上这个物料就是有一个父容器和多个子容器组合而成的，比如下面这个例子，整个「电梯表单」是一起被拖入到画布中的，但是电梯表单是由4个子表单，每个子表单还有一个输入框这样的组合形成的。可见，一般可视化编辑器都是以组件为单元供创作者点击选中。（<strong>最终效果截图在文末</strong>）
<img src="/pr//yuque/0/2022/png/139763/1658232820315-29ea4513-e9aa-475a-a51e-ef860627adf2.png" alt="image.png"></p> <p>这个模式在这种场景下看起来并没有什么问题，但是考虑这样一种场景，如图有一个这样的图文展示模块，业务希望所有可以看得到的元素，都能够被选中，并且被选中之后属性设置面板上就只剩下被选中块的属性配置。例如整个卡片选中，左侧显示整个卡片所有的参数配置；选中 Logo，左侧只剩下这个 Logo 属性设置；选中文本，可以单独编辑指定文本并且左侧属性面板显示文本的文本配置及样式，也可以原地编辑；如果主标题和副标题被一起选中，则右侧只显示这两个标题的设置。
首先这种所见都可编辑的、分组编辑的需求，也是合理的，更符合用户只管感受，所以是个合理的需求。
<img src="/pr//yuque/0/2022/png/139763/1658233605142-7d211a0e-2ff2-44fc-862c-25aefab4a1aa.png" alt="image.png"> <img src="/pr//yuque/0/2022/png/139763/1658233768319-3258eab4-dfe1-4c06-b634-db4a5514fa71.png" alt="image.png"></p> <h2 id="方案"><a href="#方案" class="header-anchor">#</a> 方案</h2> <p>有2个可以实现的方法，但是各自理解、开发、使用、维护成本不同，方案三是成本最小也更符合直觉的。</p> <h3 id="方案一"><a href="#方案一" class="header-anchor">#</a> 方案一</h3> <p>这种需求，如果还是按照上面 lowcode-engine 的设计逻辑来看的话，需要用组件嵌套模式，需要写至 5 个组件，并且层层组合、分别开发对应层级的 setter ，同时要将这5个子组件全部禁用掉删除、移动、新增子节点等默认功能，以避免拖入画布后被创作者误操作删除子块无法恢复。这样为了开发一个大颗粒组件而需要开发者做需要写5个碎片组件，并且每个碎片组件没有什么复用价值。本质上，是技术和需求视角的矛盾，业务需求是整个大颗粒组件是最小单元，而技术上拆分之后需要有所重组和对位置、是否可删除等加上限制，才能满足需求。
为了实现小颗粒组装成大组件，还可以这样做：开发抽象文本组件/抽象图片组件/抽象按钮组件/抽象容器组件，然后分别在物料的 schema 里引用这些抽象组件，然后分别为其写样式，这对开发者来说也是件相当麻烦的事情，编写维护代码就都是在 JSON 里写。相信没有多少开发者愿意做。
这个 JSON 自己写麻烦，那做个可视化编辑器？专门用于生产卡片的，这个可视化编辑器支持使用基础抽象图片组件、抽象文本组件，然后 css 方式自由布局，最终产物是一段物料 schema。这段 schema 可以被导入到业务的可视化编辑器里。显然这个对于开发成本、使用成本都较高。而且如果组件之间有逻辑联动，容器组件并不好写，所以这个方案可行但 ROI 很低。</p> <h3 id="方案二"><a href="#方案二" class="header-anchor">#</a> 方案二</h3> <p>对于开发者而言，最理想的符合开发和产品直觉的做法，是我只需要正常编写一个业务需要的大组件，然后在大组件的图文、区块 html 元素上标记出来，这个子块应该是对应到组件的哪个 prop 。然后让可视化编辑器的模拟器里直接以插件的方式，识别到用户点击时点中了此组件中的哪个子元素，类似下面这种结构</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Props</span><span class="token punctuation">{</span>
    <span class="token comment">/**
   * 封面卡片图片
   * @setter ImageSetter
   * @setterStandalone true
   * @default https://img0.baidu.com/it/u=437170374,76...
   * */</span>
  cover<span class="token operator">:</span> <span class="token builtin">string</span>
  background<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RegisterCard</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>PureComponent<span class="token operator">&lt;</span>Props<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> background<span class="token punctuation">,</span> cover <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'register-card'</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> background <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/** 这个 img 元素会被作为可单独选中子区域 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token punctuation">{</span>cover<span class="token punctuation">}</span> alt<span class="token operator">=</span><span class="token string">&quot;&quot;</span> data<span class="token operator">-</span>live<span class="token operator">-</span>select<span class="token operator">=</span><span class="token string">'cover'</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'text-block'</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;register-band-title&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如代码中的 img 标签，上面附加了 data-live-select，并且值指定的是 prop 里的 cover，代表这个元素对应了  prop.cover，这样在 setter 里就可以查找到对应的属性应该是什么类型的 prop，然后展示其对应的 setter。</p> <h2 id="多层与循环"><a href="#多层与循环" class="header-anchor">#</a> 多层与循环</h2> <p>data-live-select 表达的，准确来说不是一个一个属性的 key，而是 key path，类比 Lodash 里的 <a href="https://lodash.com/docs/4.17.15#get" target="_blank" rel="noopener noreferrer">key path<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 比如 <code>blocks.0.title</code> 代表编辑 prop 的 blocks 属性，blocks 属性是个数组，编辑的是它第 0 个的 title 属性。对于多层/循环而言，data-live-select 的值只需要填写完整的 key path 即可，完整例子如下方代码：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">interface</span> <span class="token class-name">ComponentProp</span> <span class="token punctuation">{</span>
  blocks<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
    * 图片
    * @setter MediaSetter
    * */</span>
    media<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
      * 地址
      */</span>
      src<span class="token operator">:</span> <span class="token builtin">string</span>
      <span class="token comment">/**
      * 媒体类型
      */</span>
      type<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'video'</span> <span class="token operator">|</span> <span class="token string">'image'</span>
    <span class="token punctuation">}</span>
      <span class="token comment">/** 标题 */</span>
      title<span class="token operator">:</span> <span class="token builtin">string</span>
      <span class="token comment">/**
      * 正文
      * @setterHideLabel true
      * @setterConfig {&quot;element&quot;:&quot;textarea&quot;,&quot;maxLength&quot;:100,&quot;rows&quot;:6,&quot;field&quot;:&quot;text&quot;}
      * */</span>
      txt<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
        * 正文
        * @setterConfig {&quot;element&quot;:&quot;textarea&quot;,&quot;maxLength&quot;:100,&quot;rows&quot;:6}
        * */</span>
        text<span class="token operator">:</span> <span class="token builtin">string</span>
        <span class="token comment">/**
        * 块文本字体样式
        * @setterStandalone true
        * @setterHideLabel true
        * */</span>
        style<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">/** 是否加粗 */</span>
          bold<span class="token operator">:</span> <span class="token builtin">boolean</span>
          <span class="token comment">/** 是否斜体 */</span>
          italic<span class="token operator">:</span> <span class="token builtin">boolean</span>
          <span class="token comment">/** 字体大小 */</span>
          fontSize<span class="token operator">:</span> <span class="token builtin">number</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>
        blocks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span> <span class="token attr-name">data-live-select</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">blocks.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-live-select</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">blocks.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.media</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>block<span class="token punctuation">.</span>media<span class="token operator">?.</span>src<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-live-select</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">blocks.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.title</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>block<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-live-select</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">blocks.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.txt</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>block<span class="token punctuation">.</span>txt<span class="token operator">?.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>   
</code></pre></div><p>多层、循环，都通过 data-live-select 表达了是编辑数据中的哪个 path. 当创作者点击此 html 元素时，根据这个 path , 反查对应了 prop 里的哪个属性，以及这个 prop 的类型、setter 信息，在左侧属性面板展示出来；
在创作者通过 setter 修改了 prop 之后，又能直接使用此 key path ，借助 lodash.set 给这个 prop 修改值。</p> <h2 id="方案实现"><a href="#方案实现" class="header-anchor">#</a> 方案实现</h2> <h3 id="运行时"><a href="#运行时" class="header-anchor">#</a> 运行时</h3> <p>data-live-select 这个方案，在运行时创作者点选、 setter 展示、setter 修改 props ，在方案中已经和字面描述一样很清晰，没有什么实现难度了。大致流程是：</p> <ol><li>监听画布点击</li> <li>查看点击目标元素最近 N 层 parentElement 有无 data-live-select 的 attribute</li> <li>给整个编辑器广播事件 {组件id, 有无 live-select， live-select 的值，live-select 元素的 rect}</li> <li>模拟器监听到广播事件，根据 live-select 的 rect 绘制选中高亮框</li> <li>setter 监听到广播事件，面板根据 live-select 的值作为 key path ，查找应该选择哪个  setter</li></ol> <h3 id="构建时"><a href="#构建时" class="header-anchor">#</a> 构建时</h3> <p>但是这里有个前置依赖：props 是需要支持多层嵌套的，也就是类似：之前的<a href="https://www.yuque.com/xiwen-bxuha/pr/lgodzi#HFCFP" target="_blank" rel="noopener noreferrer">组件元信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>需要增加一个扩展：propType 需要支持 object / array 等，并且增加一个 children 属性，children 是一个递归组合，和 prop 一样</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Prop</span> <span class="token punctuation">{</span>
  <span class="token comment">// 其他属性略去</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">/** 参数类型 */</span>
    propType<span class="token operator">:</span> <span class="token string">&quot;union&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;number&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 其他属性略去</span>
    <span class="token comment">/** 当 propType 是 object 时, children 是和自身数据结构相同的一个子结构 */</span>
    children<span class="token operator">:</span> Prop<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language- extra-class"><pre><code>回顾 lowcode-engine 里的方案，发现物料描述并不包含 children，是需要新增的一部分。由于我自建的可视化编辑器是复用的 lowcode-engine 里的 react-typescript-docgen，这个库只支持解析组件里的 Prop 的第一级属性，也就是上面这个例子 [ComponentProp](#IZvQd) 更深层的 blocks 是完全不支持解析出来的，react-typescript-docgen 只会解析成 `blocks: { propType: 'object' }`，而 blocks 的子属性完全忽略了。详细原因和分析可以[参考阅读此处](https://www.yuque.com/xiwen-bxuha/pr/ye33ct)。
</code></pre></div><p>经过对 react-typescript-docgen 的覆写，最终实现 typescript-react 组件的解析效果如图：
<img src="/pr//yuque/0/2022/png/139763/1658236614248-1360fad7-22c4-434e-b6ca-ded0f85dfe43.png" alt="image.png"></p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p><strong>框架应该做的事情，是整个应用里比较复杂且业务无关的脏活，把最舒适的开发体检留给内容开发</strong>。诚然，这个 attribute 的写法稍微入侵了组件库，让组件库多了一些不是组件本身的标记属性，同时也需要可视化编辑器框架增加一个插件来实现这个识别 attribute 元素的功能，还要求自己实现一个构建时有一个比 react-typescript-docgen 更高级的 typescript 解析能力，框架层面的工作多了很多，但是最终的开发体验比起其他方案优雅干净了许多。
实现的效果如图，点击操作可以实现点击组件高亮组件并显示组件 props、点击子元素高亮此元素并展示此属性的 prop 。支持任意层的嵌套、支持循环渲染等：
<img src="/pr//yuque/0/2022/png/139763/1658578683602-12868c69-1e00-4104-86e7-d6e9fbc1a956.png" alt="image.png"> <img src="/pr//yuque/0/2022/png/139763/1658578711228-b5f0ff3a-8861-4c4f-b423-12cfd4f1b22f.png" alt="image.png"> <img src="/pr//yuque/0/2022/png/139763/1658578738601-15af64e1-1ad6-4226-b892-640516c6aa08.png" alt="image.png"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pr/pr/lc/material-args.html" class="prev">
        编排 - 变量参数
      </a></span> <span class="next"><a href="/pr/pr/lc/overview-parts.html">
        概念 - 编辑器核心框架
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/pr/assets/js/app.b652a85f.js" defer></script><script src="/pr/assets/js/2.846b7fc6.js" defer></script><script src="/pr/assets/js/1.bc703a74.js" defer></script><script src="/pr/assets/js/37.fbdf6108.js" defer></script>
  </body>
</html>
