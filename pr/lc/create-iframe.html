<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>细节 - 如何创建 iframe | xiujava</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="jiawen 的博客">
    
    <link rel="preload" href="/assets/css/0.styles.acc2b136.css" as="style"><link rel="preload" href="/assets/js/app.ae098b94.js" as="script"><link rel="preload" href="/assets/js/2.846b7fc6.js" as="script"><link rel="preload" href="/assets/js/1.bc703a74.js" as="script"><link rel="preload" href="/assets/js/34.bc893c08.js" as="script"><link rel="prefetch" href="/assets/js/10.afb24a76.js"><link rel="prefetch" href="/assets/js/11.26a4e38a.js"><link rel="prefetch" href="/assets/js/12.972428b2.js"><link rel="prefetch" href="/assets/js/13.363a2818.js"><link rel="prefetch" href="/assets/js/14.da87bb03.js"><link rel="prefetch" href="/assets/js/15.be6c279e.js"><link rel="prefetch" href="/assets/js/16.5b27973e.js"><link rel="prefetch" href="/assets/js/17.e9441626.js"><link rel="prefetch" href="/assets/js/18.73cc4e61.js"><link rel="prefetch" href="/assets/js/19.04ead57f.js"><link rel="prefetch" href="/assets/js/20.a59fc3ba.js"><link rel="prefetch" href="/assets/js/21.08fe35aa.js"><link rel="prefetch" href="/assets/js/22.827a5b12.js"><link rel="prefetch" href="/assets/js/23.4f7ffd82.js"><link rel="prefetch" href="/assets/js/24.f951cc52.js"><link rel="prefetch" href="/assets/js/25.69a8b217.js"><link rel="prefetch" href="/assets/js/26.53346931.js"><link rel="prefetch" href="/assets/js/27.7fbf6cac.js"><link rel="prefetch" href="/assets/js/28.3e339daa.js"><link rel="prefetch" href="/assets/js/29.6cf6ca93.js"><link rel="prefetch" href="/assets/js/3.7d9825a9.js"><link rel="prefetch" href="/assets/js/30.342ebd9d.js"><link rel="prefetch" href="/assets/js/31.0442f702.js"><link rel="prefetch" href="/assets/js/32.daa02c22.js"><link rel="prefetch" href="/assets/js/33.ebf9af3c.js"><link rel="prefetch" href="/assets/js/35.70c7c053.js"><link rel="prefetch" href="/assets/js/36.246d6c9c.js"><link rel="prefetch" href="/assets/js/37.8e94202d.js"><link rel="prefetch" href="/assets/js/38.63b25286.js"><link rel="prefetch" href="/assets/js/39.f225082b.js"><link rel="prefetch" href="/assets/js/4.1b5a2940.js"><link rel="prefetch" href="/assets/js/40.4cb44a86.js"><link rel="prefetch" href="/assets/js/41.f73ad1f8.js"><link rel="prefetch" href="/assets/js/42.626a30be.js"><link rel="prefetch" href="/assets/js/43.91f67b4b.js"><link rel="prefetch" href="/assets/js/44.9eac489e.js"><link rel="prefetch" href="/assets/js/45.df9318ca.js"><link rel="prefetch" href="/assets/js/46.44570272.js"><link rel="prefetch" href="/assets/js/47.be81fd04.js"><link rel="prefetch" href="/assets/js/48.5015b80e.js"><link rel="prefetch" href="/assets/js/49.4dec6231.js"><link rel="prefetch" href="/assets/js/5.0d0d8c0c.js"><link rel="prefetch" href="/assets/js/50.ab02ecad.js"><link rel="prefetch" href="/assets/js/51.c3f45b43.js"><link rel="prefetch" href="/assets/js/52.43881e80.js"><link rel="prefetch" href="/assets/js/53.089a5dc4.js"><link rel="prefetch" href="/assets/js/54.50c11d45.js"><link rel="prefetch" href="/assets/js/55.e2c9f89d.js"><link rel="prefetch" href="/assets/js/56.f2a8cba6.js"><link rel="prefetch" href="/assets/js/57.396052cf.js"><link rel="prefetch" href="/assets/js/58.22acf40d.js"><link rel="prefetch" href="/assets/js/59.d621787d.js"><link rel="prefetch" href="/assets/js/6.ec95ead8.js"><link rel="prefetch" href="/assets/js/60.5b939ba1.js"><link rel="prefetch" href="/assets/js/7.aa392645.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.acc2b136.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">xiujava</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NLP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>低代码系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pr/lc/platform.html" class="sidebar-link">生态 - 产品与平台生态</a></li><li><a href="/pr/lc/framer.html" class="sidebar-link">他山 - Framer</a></li><li><a href="/pr/lc/tech-choice.html" class="sidebar-link">概念 - 选型设计与调研</a></li><li><a href="/pr/lc/skill-point.html" class="sidebar-link">概念 - 技术难点</a></li><li><a href="/pr/lc/material.html" class="sidebar-link">入料 - 物料类型</a></li><li><a href="/pr/lc/material-args.html" class="sidebar-link">编排 - 变量参数</a></li><li><a href="/pr/lc/material-node.html" class="sidebar-link">编排 - 比组件更小的子元素</a></li><li><a href="/pr/lc/overview-parts.html" class="sidebar-link">概念 - 编辑器核心框架</a></li><li><a href="/pr/lc/create-iframe.html" aria-current="page" class="active sidebar-link">细节 - 如何创建 iframe</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#原因" class="sidebar-link">原因</a></li><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#实验" class="sidebar-link">实验</a></li><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#溯源" class="sidebar-link">溯源</a></li><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#正解" class="sidebar-link">正解</a></li><li class="sidebar-sub-header"><a href="/pr/lc/create-iframe.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术分享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂谈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="细节-如何创建-iframe"><a href="#细节-如何创建-iframe" class="header-anchor">#</a> 细节 - 如何创建 iframe</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>低代码总是需要一个 iframe 画布的，用于做样式和 JS 隔离，虽然 js 沙盒、shadowdom 也似乎可以模仿类似操作，但是如果 iframe 内的 css 想用 @media 媒体查询呢？想来还是只有 iframe 靠谱。</p> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <p>Iframe 的创建和操作都很简单，就是 ref 和 contentDocument 这两个 api ，剩下的都是 web 常规操作，但是如何往 iframe 里写入，这里就有个小水坑，参考下面两种写法</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">FramePortal</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>PureComponent<span class="token operator">&lt;</span>SimulatorProps <span class="token operator">&amp;</span> Pick<span class="token operator">&lt;</span>Offset<span class="token punctuation">,</span> <span class="token string">'scale'</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
  containerEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iframe<span class="token operator">?</span><span class="token operator">:</span> HTMLIFrameElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">get</span> <span class="token function">doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iframe<span class="token operator">!</span><span class="token punctuation">.</span>contentDocument<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iframe<span class="token operator">!</span><span class="token punctuation">.</span>contentWindow <span class="token keyword">as</span> Window <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
      React<span class="token operator">:</span> <span class="token keyword">typeof</span> React<span class="token punctuation">,</span>
      ReactDOM<span class="token operator">:</span> <span class="token keyword">typeof</span> ReactDOM<span class="token punctuation">,</span>
      simulator<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ComponentType<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> doc<span class="token punctuation">,</span> win <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doc <span class="token operator">||</span> <span class="token operator">!</span>win<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// @ts-ignore</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>containerEl<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'designer-simulator'</span><span class="token punctuation">;</span>
    doc<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerEl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> script <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'window.React=parent.React;window.ReactDOM=parent.ReactDOM;window.__REACT_DEVTOOLS_GLOBAL_HOOK__ = window.parent.__REACT_DEVTOOLS_GLOBAL_HOOK__;window.__is_in_simulator__=true;'</span><span class="token punctuation">;</span>
    doc<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    doc<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'simulator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>url <span class="token operator">=&gt;</span> <span class="token function">installDependency</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      win<span class="token punctuation">.</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
        win<span class="token punctuation">.</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>simulator<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
        doc<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerEl<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> win<span class="token punctuation">,</span> doc <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> scale <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> grow <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">100</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>scale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>iframe title<span class="token operator">=</span><span class="token string">&quot;simulator&quot;</span> name<span class="token operator">=</span><span class="token string">'simulator'</span>
        ref<span class="token operator">=</span><span class="token punctuation">{</span>el <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iframe <span class="token operator">=</span> el<span class="token punctuation">}</span>
        style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scale(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> width<span class="token operator">:</span> grow<span class="token punctuation">,</span> height<span class="token operator">:</span> grow <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">FramePortal</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>PureComponent<span class="token operator">&lt;</span>SimulatorProps <span class="token operator">&amp;</span> Pick<span class="token operator">&lt;</span>Offset<span class="token punctuation">,</span> <span class="token string">'scale'</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
  iframe<span class="token operator">?</span><span class="token operator">:</span> HTMLIFrameElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">get</span> <span class="token function">doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iframe<span class="token operator">!</span><span class="token punctuation">.</span>contentDocument<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iframe<span class="token operator">!</span><span class="token punctuation">.</span>contentWindow <span class="token keyword">as</span> Window <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
      React<span class="token operator">:</span> <span class="token keyword">typeof</span> React<span class="token punctuation">,</span>
      ReactDOM<span class="token operator">:</span> <span class="token keyword">typeof</span> ReactDOM<span class="token punctuation">,</span>
      simulator<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ComponentType<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> doc<span class="token punctuation">,</span> win <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doc <span class="token operator">||</span> <span class="token operator">!</span>win<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// @ts-ignore</span>
    doc<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    doc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;!doctype html&gt;
  &lt;html class=&quot;engine-design-mode&quot;&gt;
    &lt;head&gt;&lt;meta charset=&quot;utf-8&quot;/&gt;&lt;/head&gt;
    &lt;body class=&quot;simulator&quot;&gt;
    &lt;script&gt;
      window.React=parent.React;window.ReactDOM=parent.ReactDOM;window.__REACT_DEVTOOLS_GLOBAL_HOOK__ = window.parent.__REACT_DEVTOOLS_GLOBAL_HOOK__;window.__is_in_simulator__=true;
    &lt;/script&gt;
    &lt;div id=&quot;designer-simulator&quot;&gt;&lt;/div&gt;
    &lt;/body&gt;
  &lt;/html&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    doc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>url <span class="token operator">=&gt;</span> <span class="token function">installDependency</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      win<span class="token punctuation">.</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
        win<span class="token punctuation">.</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>simulator<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
        doc<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'designer-simulator'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> win<span class="token punctuation">,</span> doc <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> scale <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> grow <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">100</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>scale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>iframe title<span class="token operator">=</span><span class="token string">&quot;simulator&quot;</span> name<span class="token operator">=</span><span class="token string">'simulator'</span>
        ref<span class="token operator">=</span><span class="token punctuation">{</span>el <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iframe <span class="token operator">=</span> el<span class="token punctuation">}</span>
        style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scale(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> width<span class="token operator">:</span> grow<span class="token punctuation">,</span> height<span class="token operator">:</span> grow <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> FramePortal<span class="token punctuation">;</span>

</code></pre></div><p>我一开始用的是第一种写法，因为第一种更加 api 化，你看第二种，它这么长一串字符串代码，怎叫人放心没有个小 bug ？一开始写法1都没问题，一直能正常使用，结果发现了个问题：它 iframe 里面的代码如果发起请求，当前域名是 about:blank，那跟主应用不共享 location、storage等等，也就限制了画布内的组件在编辑态内使用 window.location 之类的，而改成第二种则不会。虽说问题不大，但是就像鞋子里的沙子，每次硌脚都会想为什么我不早点解决这个问题</p> <h2 id="原因"><a href="#原因" class="header-anchor">#</a> 原因</h2> <p>这个不太好查到底是什么区别，然后问了 GPT4，它是这么回复的</p> <blockquote><p>这两种情况下的差异主要在于 iframe 的源（origin）。
在第一种情况下，你直接修改了 iframe 的 contentDocument，而 iframe 的源默认是 &quot;about:blank&quot;，这与你的主页面的源 &quot;<a href="https://example.com/" target="_blank" rel="noopener noreferrer">https://example.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>&quot; 不同。因此，当你试图从 iframe 发起请求到 &quot;/api&quot; 时，浏览器将其视为跨源请求，因此会出现跨域问题。
在第二种情况下，你通过 document.open() 和 document.write() 创建了一个新的 HTML 文档，并在其中插入了 script。在这种情况下，新的 HTML 文档会继承创建它的文档的源，也就是 &quot;<a href="https://example.com/" target="_blank" rel="noopener noreferrer">https://example.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>&quot;。因此，当你从 iframe 发起请求到 &quot;/api&quot; 时，浏览器将其视为同源请求，因此不会出现跨域问题。
这就是为什么第一种情况会报跨域，而第二种情况不会的原因。</p></blockquote> <h2 id="实验"><a href="#实验" class="header-anchor">#</a> 实验</h2> <p>随便打开一个网页，唤起控制台，这样简单创建一个 iframe，发现它默认就是<code>about:blank</code>（当然了，跟新开一个 tab 一样，起始页肯定就是 about:blank）
<img src="/yuque/0/2023/png/139763/1695215445215-8be1839d-e8df-482c-9c49-24f078ab5e9d.png" alt="image.png">
继续操作,  打开这个 contentDocument，发现这个 document 的 url 变成了当前页面的 url，所以整个的差别就在于这个 document.open 方法
<img src="/yuque/0/2023/png/139763/1695215538032-17a510b3-8b4a-4e1a-b476-4f775023e92c.png" alt="image.png"></p> <h2 id="溯源"><a href="#溯源" class="header-anchor">#</a> 溯源</h2> <p>更进一步问 GPT，这个继承规范有没有技术名词，为什么这样操作就会继承，基本上就是在胡说了，不过在它提醒了可以看看 <a href="https://html.spec.whatwg.org/multipage/" target="_blank" rel="noopener noreferrer">whatwg<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，找到了这样一个规范说明 <a href="https://github.com/whatwg/html/issues/6552" target="_blank" rel="noopener noreferrer">https://github.com/whatwg/html/issues/6552<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，还有这个讨论 <a href="https://github.com/whatwg/html/issues/4510" target="_blank" rel="noopener noreferrer">https://github.com/whatwg/html/issues/4510<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
要看懂 github 这段不容易，需要先知道这两个名词 COOP 和 COEP</p> <blockquote><p>COEP（Cross-Origin-Embedder-Policy）和COOP（Cross-Origin-Opener-Policy）是浏览器标准中引入的两个安全策略，用于增强跨域资源的隔离和保护。</p> <ol><li>COEP（Cross-Origin-Embedder-Policy）：COEP 是一种安全策略，用于控制嵌入的资源（如 iframe、Web Workers、SharedArrayBuffers）与其所在页面的交互。它允许网站声明其嵌入的资源是否允许与页面共享特定的权限。COEP 可以帮助防止跨域攻击，例如数据泄露和代码注入。</li> <li>COOP（Cross-Origin-Opener-Policy）：COOP 是一种安全策略，用于控制打开的窗口（通过 window.open 或 target=&quot;_blank&quot;）与其打开者页面的交互。它允许网站声明其打开的窗口是否允许与打开者页面共享特定的权限。COOP 可以帮助防止一些攻击，如窗口间的信息泄露和恶意代码注入。</li></ol></blockquote> <p>看 issue 讨论有点云里雾里，还是缺了太多前置的背景知识，像个外行人看热闹，就干脆还是回去看看 whatwg 的协议文档，发现这里有这样一段说明
<a href="https://html.spec.whatwg.org/multipage/dynamic-markup-insertion.html#document-open-steps" target="_blank" rel="noopener noreferrer">https://html.spec.whatwg.org/multipage/dynamic-markup-insertion.html#document-open-steps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>The <strong>document open steps</strong>, given a document, are as follows:
If document is an <a href="https://dom.spec.whatwg.org/#xml-document" target="_blank" rel="noopener noreferrer">XML document<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, then throw an <a href="https://webidl.spec.whatwg.org/#invalidstateerror" target="_blank" rel="noopener noreferrer">&quot;InvalidStateError&quot;<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://webidl.spec.whatwg.org/#dfn-DOMException" target="_blank" rel="noopener noreferrer">DOMException<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> exception.</p> <ul><li>If document's <a href="https://html.spec.whatwg.org/multipage/dynamic-markup-insertion.html#throw-on-dynamic-markup-insertion-counter" target="_blank" rel="noopener noreferrer">throw-on-dynamic-markup-insertion counter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is greater than 0, then throw an <a href="https://webidl.spec.whatwg.org/#invalidstateerror" target="_blank" rel="noopener noreferrer">&quot;InvalidStateError&quot;<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://webidl.spec.whatwg.org/#dfn-DOMException" target="_blank" rel="noopener noreferrer">DOMException<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Let entryDocument be the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#entry-global-object" target="_blank" rel="noopener noreferrer">entry global object<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>'s <a href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window" target="_blank" rel="noopener noreferrer">associatedDocument<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul></blockquote> <p>....
If document is <a href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" target="_blank" rel="noopener noreferrer">fully active<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, then:</p> <blockquote><ol><li>Let newURL be a copy of entryDocument's <a href="https://dom.spec.whatwg.org/#concept-document-url" target="_blank" rel="noopener noreferrer">URL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>If entryDocument is not document, then set newURL's <a href="https://url.spec.whatwg.org/#concept-url-fragment" target="_blank" rel="noopener noreferrer">fragment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to null.</li></ol></blockquote> <p>看这里应该就是我们想要找到的原始规范了，大致意思是经过一些判断，确认了这个 document 是没有源的（一开始没写 src）会走到这一步，给 contentDocument 的 url 设置为当前页面的 url。</p> <h2 id="正解"><a href="#正解" class="header-anchor">#</a> 正解</h2> <p>文档还是有些不太熟悉的内容，感觉还是源码靠谱，规范协议有点抽象，然后真的发现 Chromium 里的这段代码
<a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/dom/document.cc;l=3082;drc=4debbed750aca54fe46c20a8c286c4b04fe483c3" target="_blank" rel="noopener noreferrer">https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/dom/document.cc;l=3082;drc=4debbed750aca54fe46c20a8c286c4b04fe483c3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">Document</span><span class="token double-colon punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>Document<span class="token operator">*</span> entered_document<span class="token punctuation">,</span>
                    ExceptionState<span class="token operator">&amp;</span> exception_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// .... 经过一系列安全校验，排除了明确是跨域的场景</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ImportLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception_state<span class="token punctuation">.</span><span class="token function">ThrowDOMException</span><span class="token punctuation">(</span>
        DOMExceptionCode<span class="token double-colon punctuation">::</span>kInvalidStateError<span class="token punctuation">,</span>
        <span class="token string">&quot;Imported document doesn't support open().&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If |document| is an XML document, then throw an &quot;InvalidStateError&quot;</span>
  <span class="token comment">// DOMException exception.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsHTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception_state<span class="token punctuation">.</span><span class="token function">ThrowDOMException</span><span class="token punctuation">(</span>DOMExceptionCode<span class="token double-colon punctuation">::</span>kInvalidStateError<span class="token punctuation">,</span>
                                      <span class="token string">&quot;Only HTML documents support open().&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If |document|'s throw-on-dynamic-markup-insertion counter is greater than</span>
  <span class="token comment">// 0, then throw an &quot;InvalidStateError&quot; DOMException.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>throw_on_dynamic_markup_insertion_count_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception_state<span class="token punctuation">.</span><span class="token function">ThrowDOMException</span><span class="token punctuation">(</span>
        DOMExceptionCode<span class="token double-colon punctuation">::</span>kInvalidStateError<span class="token punctuation">,</span>
        <span class="token string">&quot;Custom Element constructor should not use open().&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AllowedToUseDynamicMarkUpInsertion</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> exception_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// If |document|'s origin is not same origin to the origin of the responsible</span>
  <span class="token comment">// document specified by the entry settings object, then throw a</span>
  <span class="token comment">// &quot;SecurityError&quot; DOMException.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>entered_document <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">GetSecurityOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">IsSameSchemeHostPort</span><span class="token punctuation">(</span>
                              entered_document<span class="token operator">-&gt;</span><span class="token function">GetSecurityOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exception_state<span class="token punctuation">.</span><span class="token function">ThrowSecurityError</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Can only call open() on same-origin documents.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If |document| has an active parser whose script nesting level is greater</span>
  <span class="token comment">// than 0, then return |document|.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ScriptableDocumentParser<span class="token operator">*</span> parser <span class="token operator">=</span> <span class="token function">GetScriptableDocumentParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token operator">-&gt;</span><span class="token function">IsParsing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> parser<span class="token operator">-&gt;</span><span class="token function">IsExecutingScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Similarly, if |document|'s ignore-opens-during-unload counter is greater</span>
  <span class="token comment">// than 0, then return |document|.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ignore_opens_during_unload_count_<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// 最终应该是走到了这一行  </span>
  <span class="token comment">// Change |document|'s URL to the URL of the responsible document specified</span>
  <span class="token comment">// by the entry settings object.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>entered_document <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span> <span class="token operator">!=</span> entered_document<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Clear the hash fragment from the inherited URL to prevent a</span>
    <span class="token comment">// scroll-into-view for any document.open()'d frame.</span>
    KURL new_url <span class="token operator">=</span> entered_document<span class="token operator">-&gt;</span><span class="token function">Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_url<span class="token punctuation">.</span><span class="token function">SetFragmentIdentifier</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SetURL</span><span class="token punctuation">(</span>new_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>document.open 可以继承源</li> <li>为什么这样设计，文档有提到，open 方法会清空 document 的内容（实测了一下确实如此），推测正是因为这样，实际上就相当于是当前页面全权接管了这个 iframe 的全部内容，无法对原站点造成任何攻击，这一接管动作就可以认为 iframe 是当前页面的一部分了</li></ul> <p>（所以我忙活这半天，不还是 GPT 说的那么回事么……就算知其所以然，好像也没比别人多懂点什么能用得上的东西😂）</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pr/lc/overview-parts.html" class="prev">
        概念 - 编辑器核心框架
      </a></span> <span class="next"><a href="/pr/tech/scroll-bar.html">
        双滚动条的滚动逻辑
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ae098b94.js" defer></script><script src="/assets/js/2.846b7fc6.js" defer></script><script src="/assets/js/1.bc703a74.js" defer></script><script src="/assets/js/34.bc893c08.js" defer></script>
  </body>
</html>
