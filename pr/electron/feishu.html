<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>飞书客户端技术 | xiujava</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="jiawen 的博客">
    
    <link rel="preload" href="/pr/assets/css/0.styles.3978be1e.css" as="style"><link rel="preload" href="/pr/assets/js/app.b652a85f.js" as="script"><link rel="preload" href="/pr/assets/js/2.846b7fc6.js" as="script"><link rel="preload" href="/pr/assets/js/1.bc703a74.js" as="script"><link rel="preload" href="/pr/assets/js/29.ae522b2f.js" as="script"><link rel="prefetch" href="/pr/assets/js/10.afb24a76.js"><link rel="prefetch" href="/pr/assets/js/11.26a4e38a.js"><link rel="prefetch" href="/pr/assets/js/12.972428b2.js"><link rel="prefetch" href="/pr/assets/js/13.363a2818.js"><link rel="prefetch" href="/pr/assets/js/14.da87bb03.js"><link rel="prefetch" href="/pr/assets/js/15.be6c279e.js"><link rel="prefetch" href="/pr/assets/js/16.5b27973e.js"><link rel="prefetch" href="/pr/assets/js/17.e9441626.js"><link rel="prefetch" href="/pr/assets/js/18.73cc4e61.js"><link rel="prefetch" href="/pr/assets/js/19.04ead57f.js"><link rel="prefetch" href="/pr/assets/js/20.a59fc3ba.js"><link rel="prefetch" href="/pr/assets/js/21.08fe35aa.js"><link rel="prefetch" href="/pr/assets/js/22.f5ce9d9e.js"><link rel="prefetch" href="/pr/assets/js/23.47ca722c.js"><link rel="prefetch" href="/pr/assets/js/24.4fddcd23.js"><link rel="prefetch" href="/pr/assets/js/25.633c1faa.js"><link rel="prefetch" href="/pr/assets/js/26.8ab83674.js"><link rel="prefetch" href="/pr/assets/js/27.182bd1ad.js"><link rel="prefetch" href="/pr/assets/js/28.1383b35a.js"><link rel="prefetch" href="/pr/assets/js/3.7d9825a9.js"><link rel="prefetch" href="/pr/assets/js/30.bcb96b1e.js"><link rel="prefetch" href="/pr/assets/js/31.dc8342be.js"><link rel="prefetch" href="/pr/assets/js/32.1dc6f5da.js"><link rel="prefetch" href="/pr/assets/js/33.c22b5273.js"><link rel="prefetch" href="/pr/assets/js/34.8897cec6.js"><link rel="prefetch" href="/pr/assets/js/35.5dcb8c21.js"><link rel="prefetch" href="/pr/assets/js/36.11dde236.js"><link rel="prefetch" href="/pr/assets/js/37.fbdf6108.js"><link rel="prefetch" href="/pr/assets/js/38.6c386453.js"><link rel="prefetch" href="/pr/assets/js/39.bbbe93e7.js"><link rel="prefetch" href="/pr/assets/js/4.1b5a2940.js"><link rel="prefetch" href="/pr/assets/js/40.fa8a4a55.js"><link rel="prefetch" href="/pr/assets/js/41.1337de57.js"><link rel="prefetch" href="/pr/assets/js/42.974b0c08.js"><link rel="prefetch" href="/pr/assets/js/43.5ec06833.js"><link rel="prefetch" href="/pr/assets/js/44.41d4f968.js"><link rel="prefetch" href="/pr/assets/js/45.74b1a5a1.js"><link rel="prefetch" href="/pr/assets/js/46.0b447bda.js"><link rel="prefetch" href="/pr/assets/js/47.bbf6f3b2.js"><link rel="prefetch" href="/pr/assets/js/48.4e4341c7.js"><link rel="prefetch" href="/pr/assets/js/49.b676e821.js"><link rel="prefetch" href="/pr/assets/js/5.0d0d8c0c.js"><link rel="prefetch" href="/pr/assets/js/50.89ce29be.js"><link rel="prefetch" href="/pr/assets/js/51.5d694e00.js"><link rel="prefetch" href="/pr/assets/js/52.9da5a600.js"><link rel="prefetch" href="/pr/assets/js/53.3a609c95.js"><link rel="prefetch" href="/pr/assets/js/54.c2aa27ca.js"><link rel="prefetch" href="/pr/assets/js/55.7e92886a.js"><link rel="prefetch" href="/pr/assets/js/56.b2bd260a.js"><link rel="prefetch" href="/pr/assets/js/57.bc7fc028.js"><link rel="prefetch" href="/pr/assets/js/58.0b9ba301.js"><link rel="prefetch" href="/pr/assets/js/59.30303c2b.js"><link rel="prefetch" href="/pr/assets/js/6.ec95ead8.js"><link rel="prefetch" href="/pr/assets/js/60.05f954c6.js"><link rel="prefetch" href="/pr/assets/js/7.aa392645.js"><link rel="prefetch" href="/pr/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/pr/assets/css/0.styles.3978be1e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pr/" class="home-link router-link-active"><!----> <span class="site-name">xiujava</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NLP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Electron系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pr/pr/electron/feishu.html" aria-current="page" class="active sidebar-link">飞书客户端技术</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pr/pr/electron/feishu.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/pr/pr/electron/feishu.html#多窗口管理" class="sidebar-link">多窗⼝管理</a></li><li class="sidebar-sub-header"><a href="/pr/pr/electron/feishu.html#版本升级" class="sidebar-link">版本升级</a></li><li class="sidebar-sub-header"><a href="/pr/pr/electron/feishu.html#前端与-native-协作" class="sidebar-link">前端与 native 协作</a></li><li class="sidebar-sub-header"><a href="/pr/pr/electron/feishu.html#前端" class="sidebar-link">前端</a></li><li class="sidebar-sub-header"><a href="/pr/pr/electron/feishu.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/pr/pr/electron/container.html" class="sidebar-link">跨端容器</a></li><li><a href="/pr/pr/electron/electron-overview.html" class="sidebar-link">Electron 经验</a></li><li><a href="/pr/pr/electron/win7-compatible.html" class="sidebar-link">win7兼容性调研</a></li><li><a href="/pr/pr/electron/xl1.html" class="sidebar-link">扒一扒某下载软件的源码</a></li><li><a href="/pr/pr/electron/xl2.html" class="sidebar-link">扒一扒某下载软件的代码结构(二)</a></li><li><a href="/pr/pr/electron/mac11.html" class="sidebar-link">Mac11.4权限问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>低代码系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术分享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂谈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="飞书客户端技术"><a href="#飞书客户端技术" class="header-anchor">#</a> 飞书客户端技术</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>在前⽂从业务⻆度对阿⾥郎与⻜书做了⼀个对⽐之后，本⽂主要从技术⻆度，看我们和⻜书分别是如何答
题的。两者基本框架都是基于 Electron，⼀个⽤ web 技术栈实现的 PC 端应⽤框架。此前已经有对于
Electron 在阿⾥郎⾥的应⽤经验也有⼀些总结</p> <h2 id="多窗口管理"><a href="#多窗口管理" class="header-anchor">#</a> 多窗⼝管理</h2> <p>由于 Electron 可视化部分是基于 Web 窗⼝ (BrowserWindow) 来实现的，所以并不能像 native ⼀样去
创建多个相同 context 的视图 (view) ，每个窗⼝都是⼀个独⽴的 web ⻚⾯。所以即便要写的只是⼀个像
钉消息那种桌⾯⼩窗⼝，也需要单独实现⼀个 web。这样带来的问题就是如何管理多个 web ⼯程代码。
很现实的⼀个⼩例⼦：如果我在要实现钉消息⾥⾯显示当前⽤户名，(新⼿)开发者就容易不经思考顺其⾃然的从主窗⼝的代码中 import user。⽽⼀些复杂的场景下，例如⼀些底层基础调⽤、和主进程的通信逻辑，很可能就会促使各独⽴ web 之间有很多相似的东⻄，让⼯程之间变得更含混不清。
在这个问题背景下，⻜书的解决办法是标准的 Electron 多窗⼝，也就是标准的多个 html + webpack 构
建的 dist ⽬录。我们拿到的构建后的代码结构如下，包含图⽚预览、⼩程序、⽇程等窗⼝。
在解决不同窗⼝（spa⼯程）之间重复代码利⽤的⽅式是建⽴ electron-common ⽂件夹和⼀个放了很多
代码⽚段的 npm 私有库包 @byted/electron @bytesview/pc-sdk。这种管理⽅式会让⼈有个⼩疑惑：
这么多的包和⽬录，新⼿上⼿成本如何，以及各包维护成本如何
<img src="/pr//yuque/0/2021/png/139763/1637136922732-a808de7d-7b02-4938-af3c-8d6c785c81e5.png" alt="image.png"> <img src="/pr//yuque/0/2021/png/139763/1637136929573-c6c6fc0e-89ff-4a5e-a5f8-bb03b1ebbb47.png" alt="image.png">
相对来看，在阿⾥郎⾥，多 spa ⼯程的结构⼀般使⽤在直播观看端、旧版主播端、云笔记。这类应⽤的特
点是独⽴性较⾼，和阿⾥郎主体应⽤的直接关联较少。
但这些独⽴应⽤后续从业务上如果需要做⼀些深度开发，⽐如云笔记要做离线存储、和⾳视频联动，就不
可避免的要和主窗⼝⼀样具备⽂件io、 ipc 通信等基本底层能⼒。所以我们还是希望不同 spa 能保证⼀套
统⼀的运⾏时 jsapi 环境。</p> <h2 id="版本升级"><a href="#版本升级" class="header-anchor">#</a> 版本升级</h2> <p>Electron 框架开发的应⽤安装到⽤户机器上后，如果需要实现软件升级，Electron 内置了⼀个升级框架
squirrel 。⼤致原理是下载新的安装包到临时⽬录，然后提示⽤户重启或��动重启，重启时 fork 新进程将
安装包替换到安装⽬录下。
⻜书的版本升级设计了两种，⼀种是 asar 包升级，⼀种是整包升级，⽤的也是 squirrel。我的机器上经
历过⼏次 asar 升级，⼤版本升级没⻅过。所以其实可以看出来，⻜书是以前者升级⽅式为主。
资源升级从代码来看，基本包含 app.asar、Frameworks、app.asar.unpack 这三项，步骤是 检查升级
-&gt; 下载 zip 包 -&gt; md5检查 -&gt; 解压 zip -&gt; 替换资源
其中，zip 包下载和 md5 检查在代码中没找到，应该是某个独⽴窗⼝中的代码实现的。
替换资源的步骤，是由 fork ⼀个 native 程序，让其在主程序退出后来做替换和重新拉起</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span>windowManage<span class="token punctuation">.</span>mainWindow<span class="token punctuation">.</span><span class="token function">sendWebContents</span><span class="token punctuation">(</span><span class="token string">'auto-updater-download-start'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  version<span class="token punctuation">,</span>
  <span class="token literal-property property">src</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
  <span class="token literal-property property">dest</span><span class="token operator">:</span> path
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/pr//yuque/0/2021/png/139763/1637137006647-ca7d4519-c0f1-4022-84fe-5110f6dd04fd.png" alt="image.png">
⼤版本升级：包⽬录结构⾥包含 Squirrel.framework 就是使⽤了松⿏整包升级的标识</p> <p><img src="/pr//yuque/0/2021/png/139763/1637137018059-d90fdf56-701d-426c-8d55-99cc3a9dbd6c.png" alt="image.png">
阿⾥郎曾经也做过热更新 asar 的实践，但是由于安全和稳定问题，该实践搁置了。但不管怎么说⾄少从
⻜书上，我们看到这个⽅案的可⾏性。（顺带⼀提，我们集团的语雀客户端也有 asar 包升级的⽅式）</p> <h2 id="前端与-native-协作"><a href="#前端与-native-协作" class="header-anchor">#</a> 前端与 native 协作</h2> <p>Electron 的纯前端能做的事情有限，有些⽐较底层的实现需要 c++ 配合，这个在阿⾥郎⾥是双进程的。
双进程就只能依靠 IPC 通信来解决，这就导致偶尔会出现丢消息、前端进程正常运⾏native挂掉了连不上
等问题。⻜书在这⽅⾯是怎么做的呢</p> <h3 id="子进程"><a href="#子进程" class="header-anchor">#</a> ⼦进程</h3> <p>也就是⽤ nodejs api childProcess.exec/spawn 的⽅式来 fork ⼀个进程。这种⽅式⼀般是不需要通
信，像⽤命令⾏⼀样只管⼊参和 stdio print 的。⻜书也有在使⽤，下⾯这些正好也是这种形式：
截图功能：由于截图功能⽐较常⻅，都有简单可复⽤的⼩型独⽴程序可以⽀持，和业务耦合度相对较
低，⼦进程完全可以⽀撑。
AutoUpdater：需要被 fork ，作为独⽴程序才能实现在主程序退出之后能够继续运⾏，将安装包替换
到安装⽬录下
桌⾯通知：native 实现效果会更好，⽽且⼀般也不需要什么通信。被点击⼀下确认、超时隐藏，都算
是进程结束</p> <h3 id="node-addon"><a href="#node-addon" class="header-anchor">#</a> node addon</h3> <p>基于 nodejs 核⼼扩展 的⽅式, 将 c++ 编译为 .node ⽂件，这样 Electron 的 nodejs 部分就获得了
c++ 的底层能⼒。这种⼀般⽤在轻量级系统 api 调⽤。⻜书⽤到了但不限于：</p> <ul><li>屏幕捕获。如⻜书投屏前有 N 个应⽤、N 个窗⼝预览的截图（base64），就是通过这种⽅式截取的</li> <li>dock管理。mac 版本下让⼀个应⽤能有多个 dock 图标</li> <li>WiFi。获取 WiFi 状态信息</li> <li>grpc。基于 protobuf 的 rpc 通信库，c++ 编解码性能会更⾼⼀些</li></ul> <p><img src="/pr//yuque/0/2021/png/139763/1637137081881-58520bbf-cbbe-4096-91a4-34601f8d373d.png" alt="image.png"></p> <h3 id="ffi-protobuf"><a href="#ffi-protobuf" class="header-anchor">#</a> ffi+protobuf</h3> <p>阿⾥郎⾳视频曾经做过⼀次⼤改版，原来是基于 Electron 的 webrtc 做视频流编解码传输，由于版本限制
等⼀些问题，性能不够⾼，发热⼤。针对这个问题，后来的解决⽅法是把⾳视频、投屏全 native 化。⽽这
个问题在⻜书⾥解决⽅式⾮常值得称赞。
⻜书仍然是 Electron 架构，但是没有使⽤ Electron-Chrome 部分的⾳视频能⼒，⽽是⽤ c++ 写了编解
码包，通过 ffi ⽅式链接给前端。在⾳视频会议、投屏、远程控制，都是使⽤的这种⽅式，流程图如下
<img src="/pr//yuque/0/2021/png/139763/1637137151018-c26d7600-4aa8-4c9a-94df-e55af2fa6275.png" alt="image.png"> <img src="/pr//yuque/0/2021/png/139763/1637137160666-1376e9b5-438f-410e-87b1-1be99e80a16c.png" alt="image.png"></p> <p>这样的架构，前端视觉部分既能使⽤ Electron 跨平台的能⼒（UI不⽤画两次，兼容性好），⼜能在编解码
部分也是统⼀⼀套代码（C++ 编译成 dll for windows /dylib for mac，甚⾄还能 for android)。同时，
由于上层都是 Electron，就根本不存在跨进程通信的问题。我们阿⾥郎当时在处理 Electron 和 ⾳视频/
投屏 的 native 独⽴程序通信问题上花费了不少功夫。
从这种架构设计来看，他们的组织架构可能是⼤前端+native 所以才能促成这种⽅案的实施？</p> <h2 id="前端"><a href="#前端" class="header-anchor">#</a> 前端</h2> <p>React16 + react-redux + immutable.
每个⻚⾯⼀组 index.html + webpack.config.js 标准⼯程。这⾥应该没有太⼤的新意，都是能想到的标
准前端开发套路</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <h3 id="优"><a href="#优" class="header-anchor">#</a> 优</h3> <p>native 的协作处理的⾮常好，灵活根据不同场景使⽤ node addon / ffi / ⼦进程等⽅式，在跨平
台、稳定性⽅⾯都有⾮常优秀的表现。</p> <h3 id="缺"><a href="#缺" class="header-anchor">#</a> 缺</h3> <p>前端代码⼯程性不够好，代码⽚段式的 npm 包、多 spa ⼯程打包的⽅式，让其⼀致性不够好，应该
会带来⼀些⼯程管理上的问题</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pr/pr/NLP/code_and_nlp.html" class="prev">
        程序与NLP
      </a></span> <span class="next"><a href="/pr/pr/electron/container.html">
        跨端容器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/pr/assets/js/app.b652a85f.js" defer></script><script src="/pr/assets/js/2.846b7fc6.js" defer></script><script src="/pr/assets/js/1.bc703a74.js" defer></script><script src="/pr/assets/js/29.ae522b2f.js" defer></script>
  </body>
</html>
