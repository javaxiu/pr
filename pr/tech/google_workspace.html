<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Google Workspace add-ons | xiujava</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="jiawen 的博客">
    
    <link rel="preload" href="/pr/assets/css/0.styles.3978be1e.css" as="style"><link rel="preload" href="/pr/assets/js/app.b34ec94f.js" as="script"><link rel="preload" href="/pr/assets/js/2.846b7fc6.js" as="script"><link rel="preload" href="/pr/assets/js/1.bc703a74.js" as="script"><link rel="preload" href="/pr/assets/js/46.b42902a6.js" as="script"><link rel="prefetch" href="/pr/assets/js/10.afb24a76.js"><link rel="prefetch" href="/pr/assets/js/11.26a4e38a.js"><link rel="prefetch" href="/pr/assets/js/12.972428b2.js"><link rel="prefetch" href="/pr/assets/js/13.363a2818.js"><link rel="prefetch" href="/pr/assets/js/14.da87bb03.js"><link rel="prefetch" href="/pr/assets/js/15.be6c279e.js"><link rel="prefetch" href="/pr/assets/js/16.5b27973e.js"><link rel="prefetch" href="/pr/assets/js/17.e9441626.js"><link rel="prefetch" href="/pr/assets/js/18.73cc4e61.js"><link rel="prefetch" href="/pr/assets/js/19.04ead57f.js"><link rel="prefetch" href="/pr/assets/js/20.a59fc3ba.js"><link rel="prefetch" href="/pr/assets/js/21.08fe35aa.js"><link rel="prefetch" href="/pr/assets/js/22.8cb9dc27.js"><link rel="prefetch" href="/pr/assets/js/23.68778ed8.js"><link rel="prefetch" href="/pr/assets/js/24.f951cc52.js"><link rel="prefetch" href="/pr/assets/js/25.bb9d1655.js"><link rel="prefetch" href="/pr/assets/js/26.23b3f76a.js"><link rel="prefetch" href="/pr/assets/js/27.190cfa57.js"><link rel="prefetch" href="/pr/assets/js/28.3e339daa.js"><link rel="prefetch" href="/pr/assets/js/29.4eb1db41.js"><link rel="prefetch" href="/pr/assets/js/3.7d9825a9.js"><link rel="prefetch" href="/pr/assets/js/30.adc68930.js"><link rel="prefetch" href="/pr/assets/js/31.7ec8bb17.js"><link rel="prefetch" href="/pr/assets/js/32.47391ccd.js"><link rel="prefetch" href="/pr/assets/js/33.ebf9af3c.js"><link rel="prefetch" href="/pr/assets/js/34.8670c25e.js"><link rel="prefetch" href="/pr/assets/js/35.8246591f.js"><link rel="prefetch" href="/pr/assets/js/36.9794f5bd.js"><link rel="prefetch" href="/pr/assets/js/37.c8fc108f.js"><link rel="prefetch" href="/pr/assets/js/38.35e310b5.js"><link rel="prefetch" href="/pr/assets/js/39.df46d84f.js"><link rel="prefetch" href="/pr/assets/js/4.1b5a2940.js"><link rel="prefetch" href="/pr/assets/js/40.4cb44a86.js"><link rel="prefetch" href="/pr/assets/js/41.165c4d4d.js"><link rel="prefetch" href="/pr/assets/js/42.6cfaf2ba.js"><link rel="prefetch" href="/pr/assets/js/43.436765f6.js"><link rel="prefetch" href="/pr/assets/js/44.1d1d3e9b.js"><link rel="prefetch" href="/pr/assets/js/45.0bccaafe.js"><link rel="prefetch" href="/pr/assets/js/47.300d1ad2.js"><link rel="prefetch" href="/pr/assets/js/48.5015b80e.js"><link rel="prefetch" href="/pr/assets/js/49.4dec6231.js"><link rel="prefetch" href="/pr/assets/js/5.0d0d8c0c.js"><link rel="prefetch" href="/pr/assets/js/50.2267cf64.js"><link rel="prefetch" href="/pr/assets/js/51.7bdd1e94.js"><link rel="prefetch" href="/pr/assets/js/52.9da5a600.js"><link rel="prefetch" href="/pr/assets/js/53.089a5dc4.js"><link rel="prefetch" href="/pr/assets/js/54.34970eb3.js"><link rel="prefetch" href="/pr/assets/js/55.6e970c0f.js"><link rel="prefetch" href="/pr/assets/js/56.fe35ec84.js"><link rel="prefetch" href="/pr/assets/js/57.00921405.js"><link rel="prefetch" href="/pr/assets/js/58.0b9ba301.js"><link rel="prefetch" href="/pr/assets/js/59.1a42c7c8.js"><link rel="prefetch" href="/pr/assets/js/6.ec95ead8.js"><link rel="prefetch" href="/pr/assets/js/60.0523783a.js"><link rel="prefetch" href="/pr/assets/js/7.aa392645.js"><link rel="prefetch" href="/pr/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/pr/assets/css/0.styles.3978be1e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pr/" class="home-link router-link-active"><!----> <span class="site-name">xiujava</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NLP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>低代码系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>技术分享</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pr/pr/tech/scroll-bar.html" class="sidebar-link">双滚动条的滚动逻辑</a></li><li><a href="/pr/pr/tech/figma_dev_mode.html" class="sidebar-link">figma devmode</a></li><li><a href="/pr/pr/tech/figma_2_code.html" class="sidebar-link">figma导出代码</a></li><li><a href="/pr/pr/tech/ts-trick.html" class="sidebar-link">TS抽取组件描述</a></li><li><a href="/pr/pr/tech/typescript.html" class="sidebar-link">typescript 巧技</a></li><li><a href="/pr/pr/tech/api-loader.html" class="sidebar-link">low-code 模式下的数据接入方案</a></li><li><a href="/pr/pr/tech/google_workspace.html" aria-current="page" class="active sidebar-link">Google Workspace add-ons</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pr/pr/tech/google_workspace.html#google-workspace-market" class="sidebar-link">Google workspace market</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/google_workspace.html#gwa-机制" class="sidebar-link">GWA 机制</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/google_workspace.html#gwa-使用后台服务" class="sidebar-link">GWA 使用后台服务</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/google_workspace.html#应用管理" class="sidebar-link">应用管理</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/google_workspace.html#google-workspace-生态" class="sidebar-link">Google Workspace 生态</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂谈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="google-workspace-add-ons"><a href="#google-workspace-add-ons" class="header-anchor">#</a> Google Workspace add-ons</h1> <h2 id="google-workspace-market"><a href="#google-workspace-market" class="header-anchor">#</a> Google workspace market</h2> <h3 id="名词解释"><a href="#名词解释" class="header-anchor">#</a> 名词解释</h3> <ul><li><a href="https://developers.google.com/apps-script/" target="_blank" rel="noopener noreferrer">apps-script<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: 用于开发 add-ons 的编程语言，推荐语法同 javascript, 也可以使用 Java 等语言。用法类似于 serverless fc ，可用于编写谷歌定制的运行环境，包含UI api、连接 G suit 的 api ，用于开发 GWA、serverless 等应用。apps-script 对于 Google 来说就是它的生态编程语言，换言之，生态开发者在其基础上开发的应用，都是基于这一语言体系。用它来开发的应用包括但不限于：
<ol><li>作为脚本在 IDE 中直接执行一系列操作调用 G-suit 。该应用还可被三方服务器执行</li> <li>无 UI 的 Gmail 聊天机器人</li> <li>Serverless 服务，提供 get/post 请求，返回 html / json 数据</li> <li>GWA 应用</li></ol></li> <li>Add-ons: 基于 apps-script 构建的应用， app 可以是以下任意一种应用。分两大类：
<ul><li>Google workspace add-ons：谷歌套件的扩展应用 （为方便描述 Google workspace add-ons, 下文简称 GWA，非官方称呼）</li> <li>Editor add-ons：在 Docs / sheet 等文档应用里充当效率插件的应用。类似于微软办公套件里的宏脚本</li></ul></li></ul> <p>一个 GWA 可以做什么</p> <ul><li>形态：基本 UI 语言是卡片。一个典型例子是 quick-access side panel:  可嵌入到谷歌网页应用右侧的快捷启动应用</li> <li>能力：通过 api 对接 G-suit 后台服务，例如获取用户的日程、为用户创建日程</li> <li>发布：可上架到 google workspace ，供其他用户安装使用</li> <li>安装：开发一个 GWA 多处使用:  Gmail、Calendar、Driver、Docs 等</li></ul> <h2 id="gwa-机制"><a href="#gwa-机制" class="header-anchor">#</a> GWA 机制</h2> <p>按照官方文档，实现一个 homepage 型卡片， 分析其开发、运行、渲染方式</p> <h3 id="ide-代码"><a href="#ide-代码" class="header-anchor">#</a> IDE / 代码</h3> <h4 id="ide"><a href="#ide" class="header-anchor">#</a> IDE</h4> <p><a href="https://script.google.com/home/projects/1brSxLVClpnHxtERgVeLNNtPymrGbBOYS8857Vp3uy0jmFeVLkH8VJkrB/edit" target="_blank" rel="noopener noreferrer">编辑器地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <img src="/yuque/0/2022/png/139763/1647343318694-f1c2fbe9-0f2d-4c82-ae92-3a223db7ffc9.png" alt="image-20220315103051202.png"></p> <h4 id="appscript-json"><a href="#appscript-json" class="header-anchor">#</a> appscript.json</h4> <p><img src="/yuque/0/2022/png/139763/1647343336737-89843b1b-57da-4465-a829-b63640782e10.png" alt="image-20220315103232706.png"></p> <p>其中，runtimeVersion 指所使用的的语言，这里的 V8 代表用 v8 nodejs 环境运行这一程序
addOns 里的 homepageTrigger 代表点击 G-suit 右侧的图标时触发的函数。下面的 docs/slides/sheets 代表此应用安装于此三个 G-suit</p> <h4 id="app-gs"><a href="#app-gs" class="header-anchor">#</a> app.gs</h4> <p>代码较长，做了一些关键代码删减</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// appscript 描述的点击图标入口</span>
<span class="token keyword">function</span> <span class="token function">onHomepage</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createSelectionCard</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 每次刷新页面内容都需要重新执行 newCardBuild 一次</span>
<span class="token keyword">function</span> <span class="token function">createSelectionCard</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hostApp <span class="token operator">=</span> e<span class="token punctuation">[</span><span class="token string">'hostApp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> builder <span class="token operator">=</span> CardService<span class="token punctuation">.</span><span class="token function">newCardBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// &quot;From&quot; language selection &amp; text input section</span>
  <span class="token keyword">var</span> fromSection <span class="token operator">=</span> CardService<span class="token punctuation">.</span><span class="token function">newCardSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addWidget</span><span class="token punctuation">(</span><span class="token function">generateLanguagesDropdown</span><span class="token punctuation">(</span><span class="token string">'origin'</span><span class="token punctuation">,</span> <span class="token string">'From: '</span><span class="token punctuation">,</span> originLanguage<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addWidget</span><span class="token punctuation">(</span>CardService<span class="token punctuation">.</span><span class="token function">newTextInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setFieldName</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>inputText<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">'Enter text...'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setMultiline</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hostApp <span class="token operator">===</span> <span class="token string">'docs'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fromSection<span class="token punctuation">.</span><span class="token function">addWidget</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hostApp <span class="token operator">===</span> <span class="token string">'sheets'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
  <span class="token punctuation">}</span>
  builder<span class="token punctuation">.</span><span class="token function">addSection</span><span class="token punctuation">(</span>fromSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token comment">// 与宿主应用的 UI 级 api</span>
<span class="token keyword">function</span> <span class="token function">getDocsSelection</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> selection <span class="token operator">=</span> DocumentApp<span class="token punctuation">.</span><span class="token function">getActiveDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> elements <span class="token operator">=</span> selection<span class="token punctuation">.</span><span class="token function">getRangeElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'选择了文字'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> translation <span class="token operator">=</span> LanguageApp<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> e<span class="token punctuation">.</span>formInput<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> e<span class="token punctuation">.</span>formInput<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新渲染整页</span>
    <span class="token keyword">return</span> <span class="token function">createSelectionCard</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> originLanguage<span class="token punctuation">,</span> destinationLanguage<span class="token punctuation">,</span> text<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从代码可以得到 3 个关键信息</p> <ol><li>UI 是函数式操作的，不具备传统 html/js/css 的开发方式，即: 组件、样式、UI 风格，都是有限自定义的</li> <li>与宿主 app 是有单向互通方式，可以在 add-on 里使用 app 暴露出来的某些 api</li> <li>G-suit 有一些诸如翻译的编程式 api ，可以快速调用</li></ol> <p>顺带一提，代码中的 Logger.log 是在控制台输出的，并不是在浏览器 console 里</p> <p><img src="/yuque/0/2022/png/139763/1647343350088-c77730bd-39cc-4994-a2d2-ef2692fe87a2.png" alt="image-20220315105715739.png"></p> <h3 id="渲染机制"><a href="#渲染机制" class="header-anchor">#</a> 渲染机制</h3> <p>在点击 G-suit 右侧的快捷 app 入口时，发生如图的 ExecuteAddOn 请求，拉取到的 response 是一个类 protobuf 的数据。也即可以看出，上一节的代码，实际运行环境并不在前端，而是在后台的 v8 虚拟机中，运行输出为如上的数据结构，再由页面发起渲染。</p> <p><img src="/yuque/0/2022/png/139763/1647343358241-a235c6e9-039b-4cb2-90ba-1b7a0626c6ee.png" alt="image-20220315105922149.png"></p> <p>在页面上有执行操作（如按钮点击）时，会触发请求 SubmitForm</p> <p><img src="/yuque/0/2022/png/139763/1647343371456-0d7b5437-96f8-46f1-9f3e-53a2232bad6e.png" alt="image-20220315110447228.png"></p> <p>该请求返回的数据同第一次返回的结果。整个 add-on 的显示方式是有严格的样式混淆，且独立运行于 iframe 中，与宿主应用完全隔离。（看起来似乎还用了某种基于 dom-element 的类似 angular 的 mvc 的 js 框架，jsaction 名称也是混淆的）</p> <p><img src="/yuque/0/2022/png/139763/1647343380997-c75fbe2e-65ce-4690-a4cf-3a602cc81a27.png" alt="image-20220315142147531.png"></p> <p>通过上述的分析，可以来出来 GWA 的 「渲染 - service」 关系，可以简单类比微信小程序的运行机制</p> <p><img src="/yuque/__mermaid_v3/7fab6794d5b44e10d368c5e26df08199.svg" alt="">
可见这个过程是类似小程序的双线程机制（说不定小程序的机制就是照 GWA 借鉴的），区别在与小程序的双线程都在本地客户端上的两个运行沙箱环境，而 GWA 的双线程是渲染进程在前端侧，server 进程在服务端侧的 FC 里。共同点都是开发者编写的代码，并不直接运行于用户可以看到的渲染容器中，也无法通过任何手段获取到 UI 上的 dom 。而相对的，service 侧代码又能获得一定的 api 能力，小程序是有 app / 微信生态api，GWA 是有 G-Suit 系列生态套件的 api。</p> <div class="language- extra-class"><pre><code>更进一步的延伸一点，GWA 的本地操作这点，跟蚂蚁/钉钉的可交互卡片比较类似，数据会分为 localData / remoteData ，区别是可交互卡片会让开发者关注哪些是 localData，哪些是 remoteData，而 GWA 的整个开发过程，开发者全程都在 gs 文件中开发，不需要关心这些问题。
</code></pre></div><h2 id="gwa-使用后台服务"><a href="#gwa-使用后台服务" class="header-anchor">#</a> GWA 使用后台服务</h2> <p>当自定义的 GWA 应用需要有三方后台时，三方后台如何与 GWA 前端、Google server 后台产生数据联动，如何使用它的后台服务</p> <h3 id="使用-g-suit-服务"><a href="#使用-g-suit-服务" class="header-anchor">#</a> 使用 G-suit 服务</h3> <div class="language- extra-class"><pre><code>有些 g-suit 服务是无需用户授权使用的，例如 Translate，这类服务不需要额外配置就可以直接在 gs 代码中使用。使用方式是类似 `LanguageApp.translate()`  这样的全局变量。

而如果使用的是一些需要用户授权的服务，例如 Calendar、YouTube、Mail，则需要手动在 IDE 中配置服务，否则不会有 LSP 代码提示、保存代码时也会报错阻断保存/发布。

此操作实际上是对 appscripts.json 的一个可视化操作，也可以直接在 appscripts.json 中配置相应的 oauthScopes &amp; dependencies属性。其中， [OAuthScopes](https://developers.google.com/apps-script/add-ons/concepts/workspace-scopes?hl=en)
</code></pre></div><p><img src="/yuque/0/2022/png/139763/1647343392069-54df348b-b2d9-49a2-a8b6-fb0559718895.png" alt="image-20220315155335183.png"></p> <h3 id="oauth-授权三方-app"><a href="#oauth-授权三方-app" class="header-anchor">#</a> OAuth 授权三方 app</h3> <div class="language- extra-class"><pre><code>即 用户安装一个 GWA，此 GWA 需要使用某些权限，会在安装过程中由用户确认 Google 账号、授予的权限，这个过程也就是 「用户 -&gt; oauth -&gt; 授权 GWA 应用权限」 过程。当 GWA 版本更新、代码更新、所属 owner 发生变更，这一授权过程都会重新触发。

另外，此 OAuth 过程发生在 GWA 内部，GWA 开发者并不需要关心，也无法定义任何流程（一般来说也都是标准流程不应该定制）。
</code></pre></div><p><img src="/yuque/0/2022/png/139763/1647343400406-5f79d9f7-b459-4cb8-b1bf-7d177a4f77e4.png" alt="image-20220315161157216.png"><img src="/yuque/0/2022/png/139763/1647343444708-db5638e3-c7e3-4a19-a477-a568cb35b990.png" alt="image-20220315161233664.png"></p> <h3 id="app-登录三方服务器"><a href="#app-登录三方服务器" class="header-anchor">#</a> app 登录三方服务器</h3> <div class="language- extra-class"><pre><code>GWA 到开发者自己的服务器（对谷歌来说就是三方服务器），如果为了安全需要而需要用户登录，这个过程相当于 『用户 -&gt; OAuth2 -&gt; 三方服务器』。这一过程 GWA 有标准开发方案，用于登录跳转、授权、AT/RT 存储使用

以 zoom 的 GWA 应用举例
</code></pre></div><p><img src="/yuque/0/2022/png/139763/1647343469700-0493fa93-6bbd-4cda-a009-ec6a789c3b0d.png" alt="image-20220315162048559.png"><img src="/yuque/0/2022/png/139763/1647343479665-715c8a9c-54ef-4e4b-9e1b-d57a7b88da3d.png" alt="image-20220315162214579.png"></p> <p><img src="/yuque/0/2022/png/139763/1647343514919-26a15192-41e5-4a69-874d-560397fdf4ab.png" alt="image-20220315162413183.png"><img src="/yuque/0/2022/png/139763/1647343525207-3a80713d-ea43-4e48-9959-a708589fdad5.png" alt="image-20220315162751406.png"></p> <p>通过 http 抓包可以看到，zoom 的日程是通过 <a href="https://addons-pa.clients6.google.com/$rpc/google.internal.apps.addons.v1.AddOnService/ExecuteAddOn" target="_blank" rel="noopener noreferrer">https://addons-pa.clients6.google.com/$rpc/google.internal.apps.addons.v1.AddOnService/ExecuteAddOn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 返回的</p> <p>在登录成功之后，GWA 与三方服务器的通信方式，可通过 <a href="https://github.com/googleworkspace/apps-script-oauth2/blob/master/samples/NoLibrary/Code.gs" target="_blank" rel="noopener noreferrer">Nolibrary<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的方式对接，也可以通过 <a href="https://github.com/googleworkspace/apps-script-oauth2" target="_blank" rel="noopener noreferrer">app-script-oauth2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sdk 进行对接。也可以使用 apps-script 内置的一些工具如 <a href="https://developers.google.com/apps-script/reference/properties/properties-service" target="_blank" rel="noopener noreferrer">PropertiesService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这样的 k-v 存储工具或者 JDBC 来记录。Google 推荐是授权对用户只见一次，没有 RT 过期的场景。
简单代码类似</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maybeAuthorized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoke the authorization flow using the default authorization</span>
    <span class="token comment">// prompt card.</span>
    CardService<span class="token punctuation">.</span><span class="token function">newAuthorizationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAuthorizationUrl</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getAuthorizationUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setResourceDisplayName</span><span class="token punctuation">(</span><span class="token string">&quot;Display name to show to the user&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">throwException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="应用管理"><a href="#应用管理" class="header-anchor">#</a> 应用管理</h2> <div class="language- extra-class"><pre><code>不仅针对 GWA 应用，所有的 app-scripts 构建的应用都适用。官方全称为 Google Apps Script API，通过此 api 可以在本地构建、发布、监控、运行 GWA 的本地工具。
单纯新建放在 console.google 上的非 GWA 应用，本身可以被一些触发器触发运行，例如定时器等。但如果三方服务器需要主动触发，也可以通过 api 触发其运行
</code></pre></div><h2 id="google-workspace-生态"><a href="#google-workspace-生态" class="header-anchor">#</a> Google Workspace 生态</h2> <p>所有的三方 app 开发都在 <a href="https://console.cloud.google.com/apis/api/calendar-json.googleapis.com/credentials?project=newbee-344111" target="_blank" rel="noopener noreferrer">console<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中创建应用，类型取决于 app 的 manifest
<img src="/yuque/0/2022/jpeg/139763/1647346018315-6cf4a474-633c-486a-8e36-f50ec84da19b.jpeg" alt="">
通过统一的开发方式（apps-scripts）和运行环境（google workspace app）实现的生态，谷歌很多产品都能从技术角度做成体系化的东西，就像 chrome 插件与 chrome os，从而形成一个体系化的商业产品环境</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pr/pr/tech/api-loader.html" class="prev">
        low-code 模式下的数据接入方案
      </a></span> <span class="next"><a href="/pr/pr/whisper/a_and_t.html">
        所思 - 军队还是武侠
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/pr/assets/js/app.b34ec94f.js" defer></script><script src="/pr/assets/js/2.846b7fc6.js" defer></script><script src="/pr/assets/js/1.bc703a74.js" defer></script><script src="/pr/assets/js/46.b42902a6.js" defer></script>
  </body>
</html>
