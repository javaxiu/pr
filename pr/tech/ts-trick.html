<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TS抽取组件描述 | xiujava</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="jiawen 的博客">
    
    <link rel="preload" href="/pr/assets/css/0.styles.3978be1e.css" as="style"><link rel="preload" href="/pr/assets/js/app.b34ec94f.js" as="script"><link rel="preload" href="/pr/assets/js/2.846b7fc6.js" as="script"><link rel="preload" href="/pr/assets/js/1.bc703a74.js" as="script"><link rel="preload" href="/pr/assets/js/48.5015b80e.js" as="script"><link rel="prefetch" href="/pr/assets/js/10.afb24a76.js"><link rel="prefetch" href="/pr/assets/js/11.26a4e38a.js"><link rel="prefetch" href="/pr/assets/js/12.972428b2.js"><link rel="prefetch" href="/pr/assets/js/13.363a2818.js"><link rel="prefetch" href="/pr/assets/js/14.da87bb03.js"><link rel="prefetch" href="/pr/assets/js/15.be6c279e.js"><link rel="prefetch" href="/pr/assets/js/16.5b27973e.js"><link rel="prefetch" href="/pr/assets/js/17.e9441626.js"><link rel="prefetch" href="/pr/assets/js/18.73cc4e61.js"><link rel="prefetch" href="/pr/assets/js/19.04ead57f.js"><link rel="prefetch" href="/pr/assets/js/20.a59fc3ba.js"><link rel="prefetch" href="/pr/assets/js/21.08fe35aa.js"><link rel="prefetch" href="/pr/assets/js/22.8cb9dc27.js"><link rel="prefetch" href="/pr/assets/js/23.68778ed8.js"><link rel="prefetch" href="/pr/assets/js/24.f951cc52.js"><link rel="prefetch" href="/pr/assets/js/25.bb9d1655.js"><link rel="prefetch" href="/pr/assets/js/26.23b3f76a.js"><link rel="prefetch" href="/pr/assets/js/27.190cfa57.js"><link rel="prefetch" href="/pr/assets/js/28.3e339daa.js"><link rel="prefetch" href="/pr/assets/js/29.4eb1db41.js"><link rel="prefetch" href="/pr/assets/js/3.7d9825a9.js"><link rel="prefetch" href="/pr/assets/js/30.adc68930.js"><link rel="prefetch" href="/pr/assets/js/31.7ec8bb17.js"><link rel="prefetch" href="/pr/assets/js/32.47391ccd.js"><link rel="prefetch" href="/pr/assets/js/33.ebf9af3c.js"><link rel="prefetch" href="/pr/assets/js/34.8670c25e.js"><link rel="prefetch" href="/pr/assets/js/35.8246591f.js"><link rel="prefetch" href="/pr/assets/js/36.9794f5bd.js"><link rel="prefetch" href="/pr/assets/js/37.c8fc108f.js"><link rel="prefetch" href="/pr/assets/js/38.35e310b5.js"><link rel="prefetch" href="/pr/assets/js/39.df46d84f.js"><link rel="prefetch" href="/pr/assets/js/4.1b5a2940.js"><link rel="prefetch" href="/pr/assets/js/40.4cb44a86.js"><link rel="prefetch" href="/pr/assets/js/41.165c4d4d.js"><link rel="prefetch" href="/pr/assets/js/42.6cfaf2ba.js"><link rel="prefetch" href="/pr/assets/js/43.436765f6.js"><link rel="prefetch" href="/pr/assets/js/44.1d1d3e9b.js"><link rel="prefetch" href="/pr/assets/js/45.0bccaafe.js"><link rel="prefetch" href="/pr/assets/js/46.b42902a6.js"><link rel="prefetch" href="/pr/assets/js/47.300d1ad2.js"><link rel="prefetch" href="/pr/assets/js/49.4dec6231.js"><link rel="prefetch" href="/pr/assets/js/5.0d0d8c0c.js"><link rel="prefetch" href="/pr/assets/js/50.2267cf64.js"><link rel="prefetch" href="/pr/assets/js/51.7bdd1e94.js"><link rel="prefetch" href="/pr/assets/js/52.9da5a600.js"><link rel="prefetch" href="/pr/assets/js/53.089a5dc4.js"><link rel="prefetch" href="/pr/assets/js/54.34970eb3.js"><link rel="prefetch" href="/pr/assets/js/55.6e970c0f.js"><link rel="prefetch" href="/pr/assets/js/56.fe35ec84.js"><link rel="prefetch" href="/pr/assets/js/57.00921405.js"><link rel="prefetch" href="/pr/assets/js/58.0b9ba301.js"><link rel="prefetch" href="/pr/assets/js/59.1a42c7c8.js"><link rel="prefetch" href="/pr/assets/js/6.ec95ead8.js"><link rel="prefetch" href="/pr/assets/js/60.0523783a.js"><link rel="prefetch" href="/pr/assets/js/7.aa392645.js"><link rel="prefetch" href="/pr/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/pr/assets/css/0.styles.3978be1e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pr/" class="home-link router-link-active"><!----> <span class="site-name">xiujava</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pr/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://www.yuque.com/xiwen-bxuha/pr/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  yuque
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/javaxiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NLP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>低代码系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>技术分享</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pr/pr/tech/scroll-bar.html" class="sidebar-link">双滚动条的滚动逻辑</a></li><li><a href="/pr/pr/tech/figma_dev_mode.html" class="sidebar-link">figma devmode</a></li><li><a href="/pr/pr/tech/figma_2_code.html" class="sidebar-link">figma导出代码</a></li><li><a href="/pr/pr/tech/ts-trick.html" aria-current="page" class="active sidebar-link">TS抽取组件描述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pr/pr/tech/ts-trick.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/ts-trick.html#代码分析" class="sidebar-link">代码分析</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/ts-trick.html#部分代码截图说明" class="sidebar-link">部分代码截图说明</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/ts-trick.html#compiler-host" class="sidebar-link">compiler host</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/ts-trick.html#🐂🍺的地方" class="sidebar-link">🐂🍺的地方</a></li><li class="sidebar-sub-header"><a href="/pr/pr/tech/ts-trick.html#有趣的效果" class="sidebar-link">有趣的效果</a></li></ul></li><li><a href="/pr/pr/tech/typescript.html" class="sidebar-link">typescript 巧技</a></li><li><a href="/pr/pr/tech/api-loader.html" class="sidebar-link">low-code 模式下的数据接入方案</a></li><li><a href="/pr/pr/tech/google_workspace.html" class="sidebar-link">Google Workspace add-ons</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂谈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ts抽取组件描述"><a href="#ts抽取组件描述" class="header-anchor">#</a> TS抽取组件描述</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>低代码入料部分，玩的<a href="https://www.yuque.com/lce/doc/yhgcqb" target="_blank" rel="noopener noreferrer">花样<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>很多，手动编写低代码组件描述，或者通过 ReactProps 语法识别，或者通过 Typescript 注释识别。其中，通过 Typescript 识别的部分则是基于 <a href="https://github.com/styleguidist/react-docgen-typescript" target="_blank" rel="noopener noreferrer">react-docgen-typescript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (以下简称 RDT )来实现的。另外，dumi 的<a href="https://d.umijs.org/zh-CN/guide/advanced#%E7%BB%84%E4%BB%B6-api-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90" target="_blank" rel="noopener noreferrer">文档生成<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>实际上也是通过 RDT 来实现的，包括 <a href="https://github.com/doczjs/docz/tree/main/core" target="_blank" rel="noopener noreferrer">docz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> （现在的还有很多其他知名或不知名的足 ts 扫描多是基于 RDT）。
而这个 RDT 实际上并没有预想中的那么强大，只是有限的识别了一部分 ast 范式。我在实际使用这个库的过程中踩了不少它的坑。它的问题包括但不限于：</p> <ol><li>不支持深层级的类型声明 <a href="https://github.com/styleguidist/react-docgen-typescript/issues/202" target="_blank" rel="noopener noreferrer">issue202<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>不支持组件以外的 ts 文档生成 <a href="https://github.com/styleguidist/react-docgen-typescript/issues/434" target="_blank" rel="noopener noreferrer">issue434<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>不支持传入源码直接分析 ts 声明，只能直接扫描硬盘文件 <a href="https://github.com/styleguidist/react-docgen-typescript/issues/439" target="_blank" rel="noopener noreferrer">issue439<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <p>这三点对于需要提高编译性能、插件使用范围都是很大的问题。不过它的代码也非常值得参考，本文就是在阅读其源码过程中的一些分析和收获。</p> <h2 id="代码分析"><a href="#代码分析" class="header-anchor">#</a> 代码分析</h2> <p>简单流程如下
<img src="/yuque/0/2022/jpeg/139763/1656056355140-c730a9b5-3f44-413b-bd8a-c37bbac24348.jpeg" alt="">
用到了几个关键 ts compiler api。ts compiler 的 api 并没有公开文档，以下只是根据 RDT 的代码实际情况推测的含义：</p> <ol><li>getExportsOfModule: 获取 sourceFile 的导出模块</li> <li>getAliasedSymbol: 获取实际定义的类型，忽略中间的引用/赋值关系 (Reference/PropertiesAssign)</li> <li>type.getCallSignatures()  函数式组件通过这个 api 获取到调用函数签名</li> <li>sig.getParameters();  通过签名获取参数类型</li> <li>type.getConstructSignatures();  获取 (React) Class 的构造类型签名</li> <li>sig.getReturnType(); 通过构造类型签名获取到实体类型</li> <li>instanceType.getProperty('props');  通过实体类型获取它的 props 属性的类型</li> <li>checker.getTypeOfSymbolAtLocation()； 使用 checker 获取 Props 的实际类型</li> <li>symbol.getApparentProperties;  获取 symbol 的显性类型</li> <li>symbol.isUnionOrIntersection；判断类型是否是 联合 类型</li> <li>checker.getAllPossiblePropertiesOfTypes;  获取全部属性</li> <li>type.getConstraint   获取泛型类型</li></ol> <p>通过这些关键 api  及流程图，大概能了解 RDT 的工作原理了：</p> <ol><li>将文件路径传递给 ts.createPropgram，得到对应的 checker / program</li> <li>获取 sourceFile 的所有导出，判断导出类型是否是 FC / ReactClass 组件，这里有个白名单类型用于确定是不是 React 组件，内置了 'Stateless', 'StyledComponentClass', 'StyledComponent', 'FunctionComponent', 'StatelessComponent', 'ForwardRefExoticComponent' 这些，也可以通过参数在外部传进来</li> <li>根据组件类型，尝试从函数���参或者 Class 实体类型的 props，得到 props 的类型符号</li> <li>获取 props 符号的类型，先排除它是泛型 / 联合类型</li> <li>到这步已经确定此类型一定是 { a, b ,c  } 这样的结构</li> <li>遍历第一层属性的类型</li></ol> <p>从以上流程，可以得到两个重要信息：</p> <ol><li>只会在文件里找到特定范式的组件。如果是一些高阶组件或者它无法判定是不是 React 组件的，它会直接忽略；所以这个 issue 提的它从根本上就不支持 <a href="https://github.com/styleguidist/react-docgen-typescript/issues/434" target="_blank" rel="noopener noreferrer">issue434<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>props 只遍历一层，并且类型不能是字面量类型/联合类型，所以这个 <a href="https://github.com/styleguidist/react-docgen-typescript/issues/202" target="_blank" rel="noopener noreferrer">issue202<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 也不会在它的支持范围里</li></ol> <h2 id="部分代码截图说明"><a href="#部分代码截图说明" class="header-anchor">#</a> 部分代码截图说明</h2> <p>截图这段代码的功能：识别代码块如果是一个 memo(comp) ，或者 forwardRef(comp) ，首先判断表达式的 symbol 名称是否是 memo/forward，其次获取 valueDeclaration，断言它是一个 expression ，用人话说也就是预期此代码块是个函数调用表达式，同时调用的函数名应该是 memo 或者 forward。最后通过 函数(expression） 的 ast 取得函数调用的第一个参数，把参数交给 checker.getSymbolAtLocation，进而得到真实的 FC 组件。
<img src="/yuque/0/2022/png/139763/1656074581970-83ba6a15-4358-4823-b8de-85456546f1c4.png" alt="image.png">
这段代码功能清晰逻辑简单，比较有代表性，事实上 react-docgen-typescript 大部分代码逻辑都是这个风格：推测一个范式 -&gt; 如果符合，取得需要的 symbol -&gt; symbol 再推测是否是特定范式 -&gt; 以此推断下一个范式 -&gt; 得到想要的类型声明结构 -&gt; 使用 SyntaxKind 得到具体类型 -&gt; 组装成描述结构。
这也是为什么有些写法可能会出问题的原因，例如项目里没有安装 react，使用了 preact，或者 tsconfig 使用的 jsx mode 是 react-jsx 或者 jsx 模式，拿到的 symbol  name 可能并非代码里描述的名字，就会推算失败，从而无法得出正确的解析结果。或者写了一些很绕的逻辑，并不在它这个范式里，例如  HOC，或者根本没有声明是个 FC，也得不到正确解析结果。</p> <h2 id="compiler-host"><a href="#compiler-host" class="header-anchor">#</a> compiler host</h2> <p>ts.createProgram 的第三个参数是 compiler host，负责 ts 编译器的 IO 逻辑，也就是说除了这个 Host 以外，ts 的核心程序都只做语法分析，并不强依赖于文件系统，文件 IO 、额外库文件读取都交由 compiler host 来实现。基于这个能力，可以为 ts compiler 在浏览器环境运行提供了基础，事实上 <a href="https://ts-ast-viewer.com/" target="_blank" rel="noopener noreferrer">https://ts-ast-viewer.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 等站点也都是基于这一能力的。而我们平时用到这一工具，其实更多是在 webpack-loader 环境，构造内存文件系统实现 sourcecode-ast 的转化。可惜的是，react-docgen-typescript 并没有实现这一能力。
为什么需要 compiler host ?  常规理解应该就是对 source code 做 ast 分析就好了，顶多就读个 tsconfig.json，那需要一个跟文件系统有关的 host 做什么？其实从里面的一个 api 就看可以看出来：<code>getTypeOfSymbolAtLocation</code>.
当有 compiler host 的时候，如果程序中遇到  <code>const Comp: React.FC</code>，会看到：
<img src="/yuque/0/2022/png/139763/1656214707975-71993509-294e-4a75-bf70-8b9bd9037dcf.png" alt="image.png">
实际上就是通过 host 的 getSourceFile 进一步读取到了 @types/react/index.d.ts 实际声明的位置，这里自然也就涉及到了文件系统。</p> <p>基于这个 Host ，我可以写个简单的 wrap，让 ts compiler host 的读写文件做了接口级的缓存，让 ts 的 IO 更高效：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 参数 hash 化</span>
<span class="token keyword">function</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">let</span> i<span class="token punctuation">;</span> <span class="token keyword">let</span> chr<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token builtin">string</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chr   <span class="token operator">=</span> <span class="token builtin">string</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hash  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span> hash<span class="token punctuation">)</span> <span class="token operator">+</span> chr<span class="token punctuation">;</span>
    hash <span class="token operator">|=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Convert to 32bit integer</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/** 相同的参数直接返回上次的请求值 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">cacheFuncByParams</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>log <span class="token operator">&amp;&amp;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> paramHash <span class="token operator">=</span> <span class="token function">hashCode</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>a <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">[</span>paramHash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cached<span class="token punctuation">[</span>paramHash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cached<span class="token punctuation">[</span>paramHash<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compilerHost <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getSourceFile</span><span class="token operator">:</span> fileName <span class="token operator">=&gt;</span> <span class="token function">getFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token operator">?.</span>sourceFile<span class="token punctuation">,</span>
  <span class="token function-variable function">getDefaultLibFileName</span><span class="token operator">:</span> opts <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ts<span class="token punctuation">.</span><span class="token function">getDefaultLibFileName</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">writeFile</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/* pass */</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getCurrentDirectory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getDirectories</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fileExists</span><span class="token operator">:</span> filename <span class="token operator">=&gt;</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">readFile</span><span class="token operator">:</span> fileName <span class="token operator">=&gt;</span> <span class="token function">getFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span>
  <span class="token function-variable function">getCanonicalFileName</span><span class="token operator">:</span> fileName <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>ts<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>useCaseSensitiveFileNames <span class="token operator">?</span> fileName <span class="token operator">:</span> fileName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useCaseSensitiveFileNames</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ts<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>useCaseSensitiveFileNames<span class="token punctuation">,</span>
  <span class="token function-variable function">getNewLine</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ts<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>newLine<span class="token punctuation">,</span>
  <span class="token function-variable function">getEnvironmentVariable</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>compilerHost<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> compilerHost<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compilerHost<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cacheFuncByParams</span><span class="token punctuation">(</span>compilerHost<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 之后在扫描 ts 预发树时，就可以直接这样使用, 实现库文件不用二次读取</span>
ts<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> options<span class="token punctuation">,</span> compilerHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="🐂🍺的地方"><a href="#🐂🍺的地方" class="header-anchor">#</a> 🐂🍺的地方</h2> <p>typescript 官网 compiler 是几乎没有文档的，搜寻了网上的，除了官网的一个 <a href="https://github.com/Microsoft/TypeScript/wiki/Using-the-Compiler-API#a-minimal-compiler" target="_blank" rel="noopener noreferrer">wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , 还有一个民间写的<a href="https://jkchao.github.io/typescript-book-chinese/compiler/program.html" target="_blank" rel="noopener noreferrer">编辑器文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就再找不到其他的了。剩下的都是一些 low得不行的<a href="https://juejin.cn/post/6844904177286512653" target="_blank" rel="noopener noreferrer">初级文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，或者是从官方 wiki 拷贝过来的<a href="https://learning-notes.mistermicheels.com/javascript/typescript/compiler-api/" target="_blank" rel="noopener noreferrer">只言片语<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。像 react-docgen-typescript 使用得这么深的 api ，真不知道是怎么做到的。不过通过这些分析，看起来 ts-compiler api 更多的使用场景其实是 ts 转 js 构建、IDE 的 LSP ，而不是用来做一般的代码提取。
以往我写过一个 <a href="https://github.com/javaxiu/api-loader/" target="_blank" rel="noopener noreferrer">api-loader <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 也是基于 ast 将 typescript 翻译成类似 json schema 和 ajax 请求代码的工具，但是也都是基于 <a href="https://ts-ast-viewer.com/" target="_blank" rel="noopener noreferrer">https://ts-ast-viewer.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，根据 ast 一层层写 node-walker 来推测信息翻译代码的，并没有 RDT 这么高阶的使用 compiler  api ，很值得学习。不过 api-loader 也不合适大量用 ts compiler api 像 react-docgen-typescript 一样去用范式推断来实现，因为 api-loader 的思路更多是原地翻译，感兴趣的可以试用一下 api-loader 。
react-docgen-typescript 不支持的那些 feature ，我正在考虑自己来实现一个，但是也正如 react-docgen-typescript 这些限制并不是因为它的设计不够通用，而是 ts-ast 本身就具备很多灵活性，而解析目标又是个确定性的，只能枚举一定量的范式来支持。但是我至少会解决这两个问题：</p> <ol><li>不支持深层嵌套的结构</li> <li>强依赖 file-system ，导致无法做成 webpack loader 等 JIT 工具</li></ol> <h2 id="有趣的效果"><a href="#有趣的效果" class="header-anchor">#</a> 有趣的效果</h2> <p>vscode 的 typescript 类型识别流程大致是  ts ast -&gt; ts symbol -&gt; ts-lsp -&gt; vscode 界面提示。下面这种复杂结构：泛型 + 合并类型 + 循环(Pick 是基于 in 语法）+ 类型推断，vscode 都可以给出正确的类型提示：
<img src="/yuque/0/2022/png/139763/1661829054014-e3ec63c0-9789-4685-92d6-38cc73758240.png" alt="image.png">
这个效果的本质原理是每一个类型都是一个 ts 里面的 Symbol ，Symbol 在 ts 的概念里，与文件路径、类型名称无关，就是一个通过 ts program 语法解析得到的一个组合模式的类型符号，它可以是一个 type / interface /class / 甚至是一个匿名类型、infer 等。Symbol 背后是层层文件查找，在使用到特定的 Symbol 的时候会调用文件系统读取到其真实类型，如图的这种例子，如果 Symbol 是一个 Object 类型，则通过类似 <code>getApparentProperties</code>这样的方法可以查询到经过了 extends、&amp; 、in 、alias、typeof js 类型转换、infer 类型推断 等各种骚操作最终合并得到的类型列表。因此 vscode 才能识别到这么复杂的类型结构。而根据这个原理，实际上我们完全可以复用其 ast 解析器，把上面这个复杂的类型给解析出来，得到如下结果：
<img src="/yuque/0/2022/png/139763/1661829435763-03335a4e-b673-4ccf-b537-9f1af1319a08.png" alt="image.png">
这里为了方便截图展示，把几个类型都写在一个文件里，把它们拆开放在不同的文件也是一样的解析效果。当然，这个效果主要还是在 react-docgen-typescript 的基础上，补充了一些递归查找的代码实现的。借此可以做的事情可以远超基础的仅针对当前文件的代码做 ast 解析可以做得到的效果。
像截图中选中的区域，是目前我写的递归解析尚未完善的地方，这里应该可以继续根据解析 symbol 背后的类型。ts 世界的类型实在太复杂，日常看到的 union 、infer、interface、literal 等，仅仅只是水面之上的冰山，要全部处理出来不是不可以，只是成本很高，且效果暂时用不着</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pr/pr/tech/figma_2_code.html" class="prev">
        figma导出代码
      </a></span> <span class="next"><a href="/pr/pr/tech/typescript.html">
        typescript 巧技
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/pr/assets/js/app.b34ec94f.js" defer></script><script src="/pr/assets/js/2.846b7fc6.js" defer></script><script src="/pr/assets/js/1.bc703a74.js" defer></script><script src="/pr/assets/js/48.5015b80e.js" defer></script>
  </body>
</html>
